class BitsIO{constructor(arrBuf){this.array_=new Uint8Array(arrBuf),this.array_index_=0,this.byte_=0,this.byte_index_=0,this.popNextByte_()}read(size){for(var i=0,j=size;j>0;)i+=this.readNextBit_()*2**(j-1),j-=1;return i}readNextBit_(){const i=(this.byte_&2**this.byte_index_)>>this.byte_index_;return 0==this.byte_index_?this.popNextByte_():this.byte_index_-=1,i}popNextByte_(){this.byte_=this.array_[this.array_index_],this.array_index_+=1,this.byte_index_=7}}class Cram{constructor(cram,crai,local_flag){if(!cram||!crai)throw"Files are Falsy";this.local_flag_=local_flag,this.cram_=new FileHandler(cram,local_flag),this.crai_=new FileHandler(crai,local_flag),this.containers_=new Map}getRecords(chr,start,end){return new Promise((resolve,reject)=>{var index=this.loadCraiFile_(),chr_list,header,id=new CramHeader(this.cram_).loadChrList().then(cl=>(chr_list=cl,cl.indexOf(chr))).catch(e=>{reject(e)}),record_lists=[];Promise.all([index,id]).then(values=>{var index=values[0],id=values[1],promises=[];return index.forEach(s=>{if(s[0]==id&&s[1]<=end&&s[1]+s[2]>=start){var records_have_pushed=this.loadAllRecordsInSlice_(s).then(records=>{var filtered=this.filterRecord_(id,start,end,records);record_lists.push(filtered)});promises.push(records_have_pushed)}}),promises}).then(promises=>{Promise.all(promises).then(()=>{var filtered_records=[];record_lists.forEach(list=>{filtered_records=filtered_records.concat(list)}),filtered_records.forEach(record=>{this.decorateRecords_(chr_list,record)}),resolve(filtered_records)}).catch(e=>{reject(e)})}).catch(e=>{reject(e)})})}loadCraiFile_(){return this.crai_.load().then(crai=>{var index=[],compressed=new Uint8Array(crai),plain,plaintext,lines;try{var gunzip;plain=new Zlib.Gunzip(compressed).decompress()}catch(error){error.toString().includes("invalid file signature")?(console.log("The crai file may be wrong, or a meddlesome browser may have unzipped it."),plain=compressed):console.error(error)}return String.fromCharCode.apply("",plain).split("\n").forEach(line=>{var l=line.split("\t");6==l.length&&index.push([parseInt(l[0],10),parseInt(l[1],10),parseInt(l[2],10),parseInt(l[3],10),parseInt(l[4],10),parseInt(l[5],10)])}),index})}loadAllRecordsInSlice_(slice_index){var container=this.loadContainer_(slice_index[3]),arrbuf=container.then(container=>this.loadSlice_(slice_index,container));return Promise.all([container,arrbuf]).then(values=>{var slice;return new CramSlice(values[0],values[1]).loadRecords()})}loadContainer_(pos){return new Promise((resolve,reject)=>{this.containers_.has(pos)&&resolve(this.containers_.get(pos));var c=new CramDataContainer(this.cram_,pos);this.containers_.set(pos,c),resolve(c)})}loadSlice_(slice_index,container){return container.loadHeaderLength().then(length=>{const slice_pos=slice_index[3]+length+slice_index[4],slice_length=slice_index[5];return this.cram_.load(slice_pos,slice_length)})}filterRecord_(id,start,end,records){var filtered=[];return records.forEach(read=>{read.refSeqId==id&&read.position<=end&&read.position+read.readLength>=start&&filtered.push(read)}),filtered}decorateRecords_(chr_list,record){record.refSeqName=chr_list[record.refSeqId],record.restoreCigar()}}class CramContainer{constructor(cram,pos){this.file_=cram,this.pos_=pos,this.stream_=void 0,this.first_load_length_=52,this.second_load_length_=void 0,this.third_load_length_=void 0,this.header_length_=void 0}getPosition(){return this.pos_}loadHeaderLength(){return void 0===this.header_length_&&(this.header_length_=this.loadHeader_()),this.header_length_}loadHeader_(){return this.file_.load(this.pos_,this.first_load_length_).then(arrBuf=>{this.stream_=new CramStream(arrBuf),this.length=this.stream_.readInt32(),this.ref_id=this.stream_.readItf8(),this.starting_ref_pos=this.stream_.readItf8(),this.alignment_span=this.stream_.readItf8(),this.number_records=this.stream_.readItf8(),this.record_counter=this.stream_.readLtf8(),this.bases=this.stream_.readLtf8(),this.number_blocks=this.stream_.readItf8(),this.landmarks_count_=this.stream_.readItf8();var remain_len=this.first_load_length_-this.stream_.tell();if(this.second_load_length_=5*this.landmarks_count_+4-remain_len,this.second_load_length_>0)return this.file_.load(this.pos_+this.first_load_length_,this.second_load_length_);this.second_load_length_=0}).then(second_buffer=>{second_buffer&&this.stream_.concat(second_buffer);for(var list=[],i=0;i<this.landmarks_count_;i++)list.push(this.stream_.readItf8());return this.landmarks=list,this.crc32=this.stream_.readUint32(),this.stream_.tell()})}}class CramDataContainer extends CramContainer{constructor(cram,pos){super(cram,pos),this.compression_header_=void 0,this.header_length_=this.loadHeader_()}loadCompressionHeaderBlock(){return this.compression_header_?this.compression_header_:(this.compression_header_=this.header_length_.then(header_length=>{this.third_load_length_=this.landmarks[0]+header_length-this.first_load_length_-this.second_load_length_}).then(()=>this.file_.load(this.pos_+this.first_load_length_+this.second_load_length_,this.third_load_length_)).then(third_buffer=>(this.stream_.concat(third_buffer),this.readCompressionHeaderBlock_())),this.compression_header_)}async readCompressionHeaderBlock_(){var header_length=await this.header_length_,b=this.stream_.readBlock(header_length),chb=new Map;const data=b.get("IO");{chb.set("pm",new Map),chb.get("pm").set("RN",!0),chb.get("pm").set("AP",!0),chb.get("pm").set("RR",!0);const size=data.readItf8(),number=data.readItf8();for(var i=0;i<number;i++){const k=String.fromCharCode.apply("",new Uint8Array(data.read(2)));var v;if("RN"==k||"AP"==k||"RR"==k)v=data.readBoolean();else if("SM"==k)v=data.read(5);else{if("TD"!=k)continue;v=this.decodeTagDictionary(data.readArrayByte())}chb.get("pm").set(k,v)}}{chb.set("dse",new Map);const size=data.readItf8(),number=data.readItf8();for(var i=0;i<number;i++){const k=String.fromCharCode.apply("",new Uint8Array(data.read(2)));var v;if(["BF","CF","RI","RL","AP","RG","MF","NS","NP","TS","NF","TL","FN","FP","DL","RS","PD","HC","MQ"].includes(k))v=data.readEncodingInt();else if(["RN","BB","QQ","IN","SC"].includes(k))v=data.readEncodingByteArray();else{if(!["FC","BS","BA","QS"].includes(k))continue;v=data.readEncodingByte()}chb.get("dse").set(k,v)}}{chb.set("tv",new Map);const size=data.readItf8(),number=data.readItf8();for(var i=0;i<number;i++){const k=data.readItf8(),key=String.fromCharCode((16711680&k)>>16,(65280&k)>>8,255&k),v=data.readEncodingByteArray();chb.get("tv").set(key,v)}}return b.set("content",chb),b}decodeTagDictionary(arrBuf){for(var data=new Int8Array(arrBuf),d=[],i=0;i+2<arrBuf.byteLength;){for(var tmp=[];data[i]!="\0".charCodeAt(0);){var tagId=String.fromCharCode(data[i],data[i+1]),tagType=String.fromCharCode(data[i+2]);tmp.push(tagId+tagType),i+=3}d.push(tmp),i+=1}return d}}class CramHeader extends CramContainer{constructor(cram){super(cram,26),this.fileid=void 0,this.chr_list=void 0,this.file_definition_length_=26,this.max_header_length_=23,this.first_load_length_=this.file_definition_length_+this.max_header_length_,this.header_length_=this.loadHeader_()}loadChrList(){return void 0!==this.chr_list?this.chr_list:(this.chr_list=this.header_length_.then(header_length=>{var block=this.stream_.readBlock(this.pos_+header_length),txt=block.get("IO").readString(block.get("rawSize")),list=[];return txt.split("\n").forEach(line=>{var words=line.split(RegExp(/\t|:/));"@SQ"==words[0]&&list.push(words[words.indexOf("SN")+1])}),list}),this.chr_list)}loadHeader_(){var head_len=this.file_.load(0,this.first_load_length_).then(arrBuf=>{this.stream_=new CramStream(arrBuf);var head=this.stream_.readString(4),version=new Uint8Array(this.stream_.read(2)),header_length;if("CRAM"!==head||3!==version[0]||0!==version[1])throw"[invalid file signature] This file is not CRAM 3.0 file.";return this.fileid=this.stream_.readString(20),this.length=this.stream_.readInt32(),this.ref_id=this.stream_.readItf8(),this.starting_ref_pos=this.stream_.readItf8(),this.alignment_span=this.stream_.readItf8(),this.number_records=this.stream_.readItf8(),this.record_counter=this.stream_.readLtf8(),this.bases=this.stream_.readLtf8(),this.number_blocks=this.stream_.readItf8(),this.landmarks=this.stream_.readArrayItf8(),this.crc32=this.stream_.readUint32(),this.stream_.tell()-this.file_definition_length_}),second_buf=head_len.then(header_length=>(this.second_load_length_=header_length+this.landmarks[1]-this.max_header_length_,this.file_.load(this.first_load_length_,this.second_load_length_)));return Promise.all([head_len,second_buf]).then(values=>(this.stream_.concat(values[1]),values[0]))}}class CramRans{constructor(input){this.input_=new CramStream(input)}ransDecode(){const order=this.input_.readInt8(),n_in=this.input_.readUint32(),n_out=this.input_.readUint32();var output=new Uint8Array(n_out);return 0==order?this.ransDecode0_(output,n_out):this.ransDecode1_(output,n_out),output.buffer}readFrequencies0_(F,C){for(var sym=this.input_.readUint8(),last_sym=sym,rle=0;;){var f=this.input_.readItf8();if(F[sym]=f,rle>0?(rle-=1,sym+=1):(sym=this.input_.readUint8())==last_sym+1&&(rle=this.input_.readUint8()),last_sym=sym,0==sym||256==sym)break}C[0]=0;for(var i=0;i<255;i++)C[i+1]=C[i]+F[i]}ransGetCumulativeFreq_(R){return 4095&R}ransGetSymbolFromFreq_(C,f){for(var s=0;s+1<C.length&&f>=C[s+1];)s+=1;return s}ransAdvanceStep_(R,c,f){return f*(R>>12)+(4095&R)-c}ransRenorm_(R){for(;R<1<<23;)R=(R<<8)+this.input_.readUint8();return R}ransDecode0_(output,nbytes){var F=new Array(256).fill(0),C=new Array(256).fill(0),R=new Array(4).fill(0);this.readFrequencies0_(F,C);for(var j=0;j<4;j++)R[j]=this.input_.readUint32();for(var i=0;i<nbytes;){for(var j=0;j<4;j++){if(i+j>=nbytes)return;var f=this.ransGetCumulativeFreq_(R[j]),s=this.ransGetSymbolFromFreq_(C,f);output[i+j]=s,R[j]=this.ransAdvanceStep_(R[j],C[s],F[s]),R[j]=this.ransRenorm_(R[j])}i+=4}}readFrequencies1_(F,C){for(var sym=this.input_.readUint8(),last_sym=sym,rle=0;this.readFrequencies0_(F[sym],C[sym]),rle>0?(rle-=1,sym+=1):(sym=this.input_.readUint8())==last_sym+1&&(rle=this.input_.readUint8()),last_sym=sym,0!=sym&&256!=sym;);}ransDecode1_(output,nbytes){var F=Array.from(new Array(256),()=>new Array(256).fill(0)),C=Array.from(new Array(256),()=>new Array(256).fill(0)),R=new Array(4).fill(0),L=new Array(4).fill(0);this.readFrequencies1_(F,C);for(var j=0;j<4;j++)R[j]=this.input_.readUint32(),L[j]=0;for(var i=0;i<nbytes/4;){for(var j=0;j<4;j++){var f=this.ransGetCumulativeFreq_(R[j]),s=this.ransGetSymbolFromFreq_(C[L[j]],f);output[i+Math.floor(j*nbytes/4)]=s,R[j]=this.ransAdvanceStep_(R[j],C[L[j]][s],F[L[j]][s]),R[j]=this.ransRenorm_(R[j]),L[j]=s}i+=1}for(i*=4;i<nbytes;)f=this.ransGetCumulativeFreq_(R[3]),s=this.ransGetSymbolFromFreq_(C[L[3]],f),output[i+Math.floor(3*nbytes/4)]=s,R[3]=this.ransAdvanceStep_(R[3],C[L[3]][s],F[L[3]][s]),R[3]=this.ransRenorm_(R[3]),L[3]=s,i+=1;return output}}class CramRecord{constructor(bf,cf){this.bf_=bf,this.cf_=cf,this.features_=new Array}getBf(){return this.bf_}getCf(){return this.cf_}setBf(bf){this.bf_=bf}pushFeature(feature){this.features_.push(feature)}toSAMString(){var str=new String;return str+=void 0===this.readName?"":this.readName,str+="\t"+(void 0===this.bf_?"":this.bf_),str+="\t"+(void 0===this.refSeqName?"":this.refSeqName),str+="\t"+(void 0===this.position?"":this.position),str+="\t"+(void 0===this.mappingQuality?"":this.mappingQuality),str+="\t"+(void 0===this.cigar?"":this.cigar),str+="\t"+(void 0===this.mateReadName?"":this.mateReadName),str+="\t"+(void 0===this.matePos?"":this.matePos),str+="\t"+(void 0===this.templateSize?"":this.templateSize),str+="\t"+(void 0===this.seq?"":this.seq)+"\t",str+="\t"+(void 0===this.qualityScore?"":this.qualityScore),str+="\t"+(void 0===this.tags?"":JSON.stringify(this.tags))}hasSoftclip(){return this.features_.forEach(map=>{if("S"==map.get("FC"))return!0}),!1}restoreCigar(){if(this.sortFeatures_(),!("cigar"in this)&&"readLength"in this)if(0!=this.features_.length){var cigar="",cigarLn=[],cigarOp=[""],lastOp="",lastOpLen=0,lastOpPos=1;this.features_.forEach(feature=>{var gap=feature.get("FP")-(lastOpPos+lastOpLen);switch(gap>0&&("M"==lastOp?cigarLn[cigarLn.length-1]+=gap:(cigarLn.push(gap),cigarOp.push("M"),lastOp="M")),lastOpPos=feature.get("FP"),feature.get("FC")){case"X":lastOpLen=1,"M"==(lastOp="M")?cigarLn[cigarLn.length-1]++:(cigarLn.push(1),cigarOp.push("M"));break;case"S":lastOpLen=feature.get("SC").length,lastOp="S",cigarLn.push(lastOpLen),cigarOp.push("S");break;case"i":lastOpLen=1,lastOp="I",cigarLn.push(1),cigarOp.push("I");break;case"I":lastOpLen=feature.get("IN").length,lastOp="I",cigarLn.push(feature.get("IN").length),cigarOp.push("I");break;case"D":lastOpLen=0,lastOp=feature.get("FC"),cigarLn.push(feature.get("DL")),cigarOp.push(feature.get("FC"));break;case"N":lastOpLen=0,lastOp=feature.get("FC"),cigarLn.push(feature.get("RS")),cigarOp.push(feature.get("FC"));break;case"P":lastOpLen=0,lastOp=feature.get("FC"),cigarLn.push(feature.get("PD")),cigarOp.push(feature.get("FC"));break;case"H":lastOpLen=0,lastOp=feature.get("FC"),cigarLn.push(feature.get("HC")),cigarOp.push(feature.get("FC"))}}),lastOpPos+lastOpLen-1<this.readLength&&("M"==lastOp?cigarLn[cigarLn.length-1]+=this.readLength-(lastOpPos+lastOpLen-1):(cigarLn.push(this.readLength-(lastOpPos+lastOpLen-1)),cigarOp.push("M")));for(var i=0;i<cigarLn.length;i++)cigar+=String(cigarLn[i])+cigarOp[i+1];this.cigar=cigar}else this.cigar=String(this.readLength)+"M"}sortFeatures_(){this.features_.sort((a,b)=>a.get("FP")-b.get("FP"))}}class CramSlice{constructor(container,arr_buf){this.container_=container,this.stream_=new CramStream(arr_buf),this.slice_header_=void 0,this.block_list_=[]}async loadRecords(){this.getSliceHeaderBlock_(),this.getBlocks_(),this.block_list_[0].set("IO",new BitsIO(this.block_list_[0].get("IO").arrayBuffer()));const n_records=this.slice_header_.get("content").get("numberOfRecords");for(var records=[],i=0;i<n_records;i++){var bf=await this.readItem_("BF","Int"),cf=await this.readItem_("CF","Int"),r=new CramRecord(bf,cf);await this.decodePositions_(r),await this.decodeNames_(r),await this.decodeMateData_(r),await this.decodeTagData_(r),0==(4&r.getBf())?await this.decodeMappedRead_(r):await this.decodeUnmappedRead_(r),records.push(r)}return this.decodeTotalMateData_(records),records}getSliceHeaderBlock_(){var b=this.stream_.readBlock(0),data=b.get("IO");return b.set("content",new Map),b.get("content").set("refSeqId",data.readItf8()),b.get("content").set("alignmentStart",data.readItf8()),b.get("content").set("alignmentSpan",data.readItf8()),b.get("content").set("numberOfRecords",data.readItf8()),b.get("content").set("recordCounter",data.readItf8()),b.get("content").set("numberOfBlocks",data.readItf8()),b.get("content").set("blockContentIds",data.readArrayItf8()),b.get("content").set("embeddedRefBasesBlockContentId",data.readItf8()),b.get("content").set("refMD5",data.read(16)),this.slice_header_=b,b}getBlocks_(){const n_blocks=1+this.slice_header_.get("content").get("blockContentIds").length;var blocks=[];this.stream_.seek(this.slice_header_.get("blockSize"));for(var i=0;i<n_blocks;i++){var b=this.stream_.readBlock();blocks.push(b)}return this.block_list_=blocks,blocks}async readItem_(key,type){var header,codec=(await this.container_.loadCompressionHeaderBlock()).get("content").get("dse").get(key);return this.decodeItem_(codec,type)}decodeItem_(codec,type){var codec_id=codec.get("codecId");if(1==codec_id){var io=this.getBlockByExternalId_(codec.get("externalId")).get("IO");if("Int"==type)return io.readItf8();if("Byte"==type)return io.read(1);throw"type "+type+" is not supported. (codecId: 1)"}if(3==codec_id){const al=codec.get("alphabet"),bl=codec.get("bit-length");if(1==bl.length&&0==bl[0])return al[0];throw"HUFFMAN decoding is in the process of being implemented."}if(5!=codec_id){if(6==codec_id)return this.block_list_[0].get("IO").read(codec.get("length"))-codec.get("offset");throw"codecId: "+str(codec_id)+" is not supported."}{var io=this.getBlockByExternalId_(codec.get("externalId")).get("IO"),a=[],cf;const stopByte=new CramStream(codec.get("stopByte")).readUint8();for(;;){var c=io.readUint8();if(c==stopByte)return a;a.push(c)}}}getBlockByExternalId_(id){var index=this.slice_header_.get("content").get("blockContentIds").indexOf(id);return this.block_list_[index+1]}async decodePositions_(r){var header;if(-2==this.slice_header_.get("content").get("refSeqId")?r.refSeqId=await this.readItem_("RI","Int"):r.refSeqId=this.slice_header_.get("content").get("refSeqid"),r.readLength=await this.readItem_("RL","Int"),0!=(await this.container_.loadCompressionHeaderBlock()).get("content").get("pm").get("AP")){void 0===this.last_position_&&(this.last_position_=this.slice_header_.get("content").get("alignmentStart"));var p=await this.readItem_("AP","Int");r.position=p+this.last_position_,this.last_position_=r.position}else{var p=await this.readItem_("AP","Int");r.position=p}r.readGroup=await this.readItem_("RG","Int")}async decodeNames_(r){var header;if((await this.container_.loadCompressionHeaderBlock()).get("content").get("pm").get("RN")){var rn=await this.readItem_("RN","ByteArray"),name="";rn.forEach(elem=>{name+=String.fromCharCode(elem)}),r.readName=name}else r.readName=this.generateName_(r)}generateName_(r){return generatedName="generatedName"+String(r.refSeqId)+"."+String(r.position),generatedName}async decodeMateData_(r){if(2==(2&r.getCf())){const mateFlag=await this.readItem_("MF","Int");var header;1==(1&mateFlag)&&r.setBf(32|r.getBf()),2==(2&mateFlag)&&r.setBf(8|r.getBf()),(await this.container_.loadCompressionHeaderBlock()).get("content").get("pm").get("RN")||(rn=await this.readItem_("RN","ByteArray"),r.readName=String(rn)),r.mateRefId=await this.readItem_("NS","Int"),r.matePos=await this.readItem_("NP","Int"),r.templateSize=await this.readItem_("TS","Int")}else 4==(4&r.getCf())&&(r.nextFrag=await this.readItem_("NF","Int"))}async decodeTagData_(r){const tagLine=await this.readItem_("TL","Int");var header=await this.container_.loadCompressionHeaderBlock(),tags={};const readTagFunc=elm=>{var name=elm.slice(0,2);const tagType=elm.slice(-1);var values_encoding=header.get("content").get("tv").get(elm).get("valuesEncoding"),tag_value;if("A"==tagType)tag_value=this.decodeItem_(values_encoding,"Char");else if("c"==tagType||"C"==tagType||"s"==tagType||"S"==tagType||"i"==tagType||"I"==tagType)tag_value=this.decodeItem_(values_encoding,"Int");else if("f"==tagType)tag_value=this.decodeItem_(values_encoding,"float32");else if("Z"==tagType)tag_value=this.decodeItem_(values_encoding,"String");else if("H"==tagType)tag_value=this.decodeItem_(values_encoding,"Hstring");else{if("B"!=tagType)return void console.error("tagType'"+String(tagType)+"' is not supported.");tag_value=this.decodeItem_(values_encoding,"ByteArray")}tags[elm]=tag_value};for(var elm of header.get("content").get("pm").get("TD")[tagLine])readTagFunc(elm);r.tags=tags}async decodeMappedRead_(r){const featureNumber=await this.readItem_("FN","Int");for(var i=0;i<featureNumber;i++)await this.decodeFeature_(r);var header;r.mappingQuality=await this.readItem_("MQ","Int"),(await this.container_.loadCompressionHeaderBlock()).get("content").get("dse").has("QS")&&(r.qualityScore=await this.readQualityScore_(r.readLength))}async decodeFeature_(r){var f=new Map,byte=await this.readItem_("FC","Byte");f.set("FC",String.fromCharCode.apply("",new Uint8Array(byte))),f.set("FP",await this.readItem_("FP","Int")),"B"==f.get("FC")?(f.set("BA",await this.readItem_("BA","Byte")),f.set("QS",await this.readItem_("QS","Byte"))):"X"==f.get("FC")?f.set("BS",await this.readItem_("BS","Byte")):"I"==f.get("FC")?f.set("IN",await this.readItem_("IN","ByteArray")):"S"==f.get("FC")?f.set("SC",await this.readItem_("SC","ByteArray")):"H"==f.get("FC")?f.set("HC",await this.readItem_("HC","Int")):"P"==f.get("FC")?f.set("PD",await this.readItem_("PD","Int")):"D"==f.get("FC")?f.set("DL",await this.readItem_("DL","Int")):"N"==f.get("FC")?f.set("RS",await this.readItem_("RS","Int")):"i"==f.get("FC")?f.set("BA",await this.readItem_("BA","Byte")):"b"==f.get("FC")?f.set("BB",await this.readItem_("BB","ByteArray")):"q"==f.get("FC")?f.set("QQ",await this.readItem_("QQ","ByteArray")):"Q"==f.get("FC")&&f.set("QS",await this.readItem_("QS","Byte")),r.pushFeature(f)}async decodeUnmappedRead_(r){b=new Array(r.readLength);for(var i=0;i<r.readLength;i++)b[i]=await this.readItem_("BA","Byte");var header;r.base=b,(await this.container_.loadCompressionHeaderBlock()).get("content").get("dse").has("QS")&&(r.qualityScore=await this.readQualityScore_(r.readLength))}async readQualityScore_(readLength){for(var qs=new Array(readLength),i=0;i<readLength;i++){var int=await this.readItem_("QS","Int");qs[i]=int+33}return String.fromCharCode.apply("",qs)}decodeTotalMateData_(records){for(var i=0;i<records.length;i++){var r=records[i];if(4==(4&r.getCf())){var n=records[i+r.nextFrag+1];if(16==(16&n.getBf())&&r.setBf(32|r.getBf()),4==(4&n.getBf())&&r.setBf(8|r.getBf()),r.mateReadName=n.readName,n.mateReadName=r.readName,r.mateRefId=n.refSeqId,n.mateRefId=r.refSeqId,r.matePos=n.position,n.matePos=r.position,r.refSeqId!=n.refSeqId)return r.templateSize=0,void(n.templateSize=0);var rmb=r.readLength-(r.hasSoftclip()?r.features.get("S").length:0),nmb=n.readLength-(n.hasSoftclip()?n.features.get("S").length:0),l=[r.position,r.position+(16!=(16&r.getBf())?rmb-1:1-rmb),n.position,n.position-(16!=(16&n.getBf())?nmb-1:1-nmb)],leftmost=Math.min(...l),rightmost=Math.max(...l),lm=l.indexOf(leftmost)<2?r:n,rm=l.indexOf(rightmost)<2?r:n;lm.templateSize=rightmost-leftmost+1,rm.templateSize=-(rightmost-leftmost+1)}}}}class CramStream{constructor(arrbuf){if(!arrbuf)throw"[CramStream] Invalid argument: arrbuf is undefined (falsy)";this.buffer_=arrbuf,this.index_=0}arrayBuffer(){return this.buffer_}concat(arrbuf){var u8a=new Uint8Array(this.buffer_.byteLength+arrbuf.byteLength);u8a.set(new Uint8Array(this.buffer_),0),u8a.set(new Uint8Array(arrbuf),this.buffer_.byteLength),this.buffer_=u8a.buffer}tell(){return this.index_}seek(i){this.index_=i}read(i){const sliced=this.buffer_.slice(this.index_,this.index_+i);return this.index_+=i,sliced}readInt8(){const view=new DataView(this.read(1));return view.getInt8(0)}readInt16(){const view=new DataView(this.read(2));return view.getInt16(0,!0)}readInt32(){const view=new DataView(this.read(4));return view.getInt32(0,!0)}readInt64(){const view=new DataView(this.read(8));return view.getBigInt64(0,!0)}readUint8(){const view=new DataView(this.read(1));return view.byteLength<1?0:view.getUint8(0)}readUint16(){const view=new DataView(this.read(2));return view.getUint16(0,!0)}readUint32(){const view=new DataView(this.read(4));return view.getUint32(0,!0)}readUint64(){const view=new DataView(this.read(8));return view.getBigUint64(0,!0)}readBoolean(){const view=new DataView(this.read(1)),i=view.getInt8(0,!0);return 1==i}readChar(){return String.fromCharCode.apply("",new Uint8Array(this.read(1)))}readString(i){return String.fromCharCode.apply("",new Uint8Array(this.read(i)))}readItf8(){const first_byte=this.readUint8();if(first_byte>>7==0)return 127&first_byte;if(first_byte>>6==2){const i=this.readUint8();return(63&first_byte)<<8|i}if(first_byte>>5==6){const i=this.readUint8(),j=this.readUint8();return(31&first_byte)<<16|i<<8|j}if(first_byte>>4==14){const i=this.readUint8(),j=this.readUint8(),k=this.readUint8();return(15&first_byte)<<24|i<<16|j<<8|k}{const i=this.readUint8(),j=this.readUint8(),k=this.readUint8(),l=this.readUint8(),num=(15&first_byte)<<28|i<<20|j<<12|k<<4|15&l;return num<2**31?num:num-2**32}}readLtf8(){const first_byte=BigInt(this.readUint8());if(first_byte>>7n==0b0n)return 0b01111111n&first_byte;if(first_byte>>6n==0b10n){const i=BigInt(this.readInt8());return(0b00111111n&first_byte)<<8n|i}if(first_byte>>5n==0b110n){const i=BigInt(this.readUint8()),j=BigInt(this.readUint8());return(0b00011111n&first_byte)<<16n|i<<8n|j}if(first_byte>>4n==0b1110n){const i=BigInt(this.readUint8()),j=BigInt(this.readUint8()),k=BigInt(this.readUint8());return(0b00001111n&first_byte)<<24n|i<<16n|j<<8n|k}if(first_byte>>3n==0b11110n){const i=BigInt(this.readUint8()),j=BigInt(this.readUint8()),k=BigInt(this.readUint8()),l=BigInt(this.readUint8());return(0b00000111n&first_byte)<<32n|i<<24n|j<<16n|k<<8n|l}if(first_byte>>2n==0b111110n){const i=BigInt(this.readUint8()),j=BigInt(this.readUint8()),k=BigInt(this.readUint8()),l=BigInt(this.readUint8()),m=BigInt(this.readUint8());return(0b00000011n&first_byte)<<40n|i<<32n|j<<24n|k<<16n|l<<8n|m}if(first_byte>>1n==0b1111110n){const i=BigInt(this.readUint8()),j=BigInt(this.readUint8()),k=BigInt(this.readUint8()),l=BigInt(this.readUint8()),m=BigInt(this.readUint8()),n=BigInt(this.readUint8());return(0b00000001n&first_byte)<<48n|i<<40n|j<<32n|k<<24n|l<<16n|m<<8n|n}if(0b11111110n==first_byte){const i=BigInt(this.readUint8()),j=BigInt(this.readUint8()),k=BigInt(this.readUint8()),l=BigInt(this.readUint8()),m=BigInt(this.readUint8()),n=BigInt(this.readUint8()),o=BigInt(this.readUint8());return i<<48n|j<<40n|k<<32n|l<<24n|m<<16n|n<<8n|o}return this.readInt64()}readArrayItf8(){var result=[];const length=this.readItf8();for(var i=0;i<length;i++)result.push(this.readItf8());return result}readArrayByte(){const length=this.readItf8();return this.read(length)}readEncodingInt(){var result=new Map;result.set("codecId",this.readItf8());const number_of_bytes_to_follow=this.readItf8();return 1==result.get("codecId")?(result.set("externalId",this.readItf8()),result):3==result.get("codecId")?(result.set("alphabet",this.readArrayItf8()),result.set("bit-length",this.readArrayItf8()),result):6==result.get("codecId")?(result.set("offset",this.readItf8()),result.set("length",this.readItf8()),result):7==result.get("codecId")?(result.set("offset",this.readItf8()),result.set("k",readItf8()),result):9==result.get("codecId")?(result.set("offset",readItf8()),result):(console.log("Error: invalid codec ID"),result)}readEncodingByte(){var result=new Map;result.set("codecId",this.readItf8());const number_of_bytes_to_follow=this.readItf8();return 1==result.get("codecId")?(result.set("externalId",this.readItf8()),result):3==result.get("codecId")?(result.set("alphabet",this.readArrayItf8()),result.set("bit-length",this.readArrayItf8()),result):(console.log("Error: invalid codec ID"),result)}readEncodingByteArray(){var result=new Map;result.set("codecId",this.readItf8());const number_of_bytes_to_follow=this.readItf8();return 4==result.get("codecId")?(result.set("lengthsEncoding",this.readEncodingInt()),result.set("valuesEncoding",this.readEncodingByte()),result):5==result.get("codecId")?(result.set("stopByte",this.read(1)),result.set("externalId",this.readItf8()),result):(console.log("Error: invalid codec ID"),result)}readBlock(pos=-1){var result=new Map;pos>=0&&this.seek(pos);const p=this.tell();result.set("method",this.readInt8()),result.set("contentTypeId",this.readInt8()),result.set("contentId",this.readItf8()),result.set("size",this.readItf8()),result.set("rawSize",this.readItf8());const data=this.read(result.get("size"));var raw_data;if(0==result.get("method"))raw_data=data;else if(1==result.get("method")){var compressed=new Uint8Array(data),gunzip,plain;raw_data=new Zlib.Gunzip(compressed).decompress().buffer}else{if(2==result.get("method"))throw"bzip2 is not supported";if(3==result.get("method"))throw"lzma is not supported";if(4!=result.get("method"))throw"unknown compression method";var cr;raw_data=new CramRans(data).ransDecode()}return result.set("IO",new CramStream(raw_data)),result.set("CRC32",this.readUint32()),result.set("blockSize",this.tell()-p),result}}class FileHandler{constructor(file,local_flag=!0){this.file_=file,this.local_flag_=local_flag}load(pos=-1,length=-1){return new Promise((resolve,reject)=>{if(this.local_flag_)if(pos>=0&&length>0){var sliced=this.file_.slice(pos,pos+length);resolve(sliced.arrayBuffer())}else resolve(this.file_.arrayBuffer());else{var oReq=new XMLHttpRequest;oReq.open("GET",this.file_),pos>=0&&length>0&&oReq.setRequestHeader("Range","bytes="+pos+"-"+(pos+length-1)),oReq.responseType="arraybuffer",oReq.onload=function(oEvent){const ab=oReq.response;ab?resolve(ab):reject(oReq.statusText)},oReq.onerror=function(){reject("An error occurred during HTTP access")},oReq.onabort=function(){reject("HTTP access is aborted.")},oReq.timeout=function(){reject("HTTP access timed out.")},oReq.send()}})}}