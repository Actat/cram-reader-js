class CramReader{constructor(r,t,i,e,s){if(!window.Worker){throw"Web Workers API is needed"}if(!r||!t){throw"Files are Falsy"}this.i=new Cram(r,t,i,e,s);this.o=new Worker("cram-reader-worker.min.js")}getRecords(r,t,i,e,s){if(e){this.o.onmessage=function(r){e(r)}}if(s){this.o.onerror=function(r){s(r)}}this.o.postMessage(this.i,r,t,i)}}class Cram{constructor(r,t,i,e,s){if(!r||!t){throw"Files are Falsy"}this.l=i;this.i=new FileHandler(r,i);this.u=new FileHandler(t,i);this.p=this.F();if(e&&s){this.P=true;var a=new FileHandler(e,i);var n=new FileHandler(s,i);this.I=new Fasta(a,n)}else{this.P=false}this._=new Map}getRecords(r,t,i){return new Promise(((e,s)=>{var a;var n=new CramHeader(this.i);var h=n.loadChrList().then((t=>{a=t;return t.indexOf(r)})).catch((r=>{s(r)}));var o=[];var v=[];Promise.all([this.p,h]).then((r=>{var e=r[0];var s=r[1];var a=[];e.forEach((r=>{if(r[0]==s&&r[1]<=i&&r[1]+r[2]>=t){var e=this.S(r).then((r=>{var e=this.q(s,t,i,r);o.push(e)}));a.push(e)}}));return a})).then((r=>Promise.all(r).then((()=>{o.forEach((r=>{v=v.concat(r)}));var r=[];v.forEach((t=>{r.push(this.U(a,t))}));return r})).catch((r=>{s(r)})))).then((r=>{Promise.all(r).then((()=>{e(v)})).catch((r=>{s(r)}))})).catch((r=>{s(r)}))}))}F(){return this.u.load().then((r=>{var t=[];var i=new Uint8Array(r);var e;try{var s=new Zlib.Gunzip(i);e=s.decompress()}catch(r){if(r.toString().includes("invalid file signature")){console.log("The crai file may be wrong, or a meddlesome browser may have unzipped it.");e=i}else{console.error(r)}}var a=String.fromCharCode.apply("",e);var n=a.split("\n");n.forEach((r=>{var i=r.split("\t");if(i.length==6){t.push([parseInt(i[0],10),parseInt(i[1],10),parseInt(i[2],10),parseInt(i[3],10),parseInt(i[4],10),parseInt(i[5],10)])}}));return t}))}S(r){var t=this.W(r[3]);var i=t.then((t=>this.j(r,t)));return Promise.all([t,i]).then((r=>{var t=new CramSlice(r[0],r[1]);return t.loadRecords()}))}W(r){return new Promise(((t,i)=>{if(this._.has(r)){t(this._.get(r))}var e=new CramDataContainer(this.i,r);this._.set(r,e);t(e)}))}j(r,t){return t.loadHeaderLength().then((t=>{const i=r[3]+t+r[4];const e=r[5];return this.i.load(i,e)}))}q(r,t,i,e){var s=[];e.forEach((e=>{if(e.refSeqId==r&&e.position<=i&&e.position+e.readLength>=t){s.push(e)}}));return s}async U(r,t){t.refSeqName=r[t.refSeqId];t.restoreCigar();if(this.P){await t.restoreSequence(this.I)}}}class FileHandler{constructor(r,t=true){this.L=r;this.l=t}load(r=-1,t=-1){return new Promise(((i,e)=>{if(this.l){if(r>=0&&t>0){var s=this.L.slice(r,r+t);i(s.arrayBuffer())}else{i(this.L.arrayBuffer())}}else{var a=new XMLHttpRequest;a.open("GET",this.L);if(r>=0&&t>0){a.setRequestHeader("Range","bytes="+r+"-"+(r+t-1))}a.responseType="arraybuffer";a.onload=function(r){const t=a.response;if(t){i(t)}else{e(a.statusText)}};a.onerror=function(){e("An error occurred during HTTP access")};a.onabort=function(){e("HTTP access is aborted.")};a.timeout=function(){e("HTTP access timed out.")};a.send()}}))}}class Fasta{constructor(r,t,i=0){if(!r||!t){throw"Files are Falsy"}this.N=r;this.X=t;this.Z=this.J();this.O={A:"T",T:"A",G:"C",C:"G",R:"Y",Y:"R",M:"K",K:"M",B:"V",V:"B",D:"H",H:"D",a:"t",t:"a",g:"c",c:"g",r:"y",y:"r",m:"k",k:"m",b:"v",v:"b",d:"h",h:"d"};this.$=i;if(this.$>0){this.rr=[[new Date,"",1,i,new Promise((r=>{r("N".repeat(i))}))]]}}loadSequence(r,t,i,e="+"){return this.loadSeq(r,t,i).then((r=>{if(e!=="-"&&e!==-1){return r}else{return this.tr(r)}}))}async loadSeq(r,t,i){if(!this.rr){return await this.ir(r,t,i)}var e=[];this.rr.sort(((r,t)=>r[2]-t[2]));for(var s=0;s<this.rr.length;s++){var a=this.rr[s];if(a[1]==r&&a[2]<=t&&a[3]>=i){this.rr[s][0]=new Date;var n=t-a[2];var h=n+(i-t)+1;var o=await a[4];return o.slice(n,h)}else if(a[1]==r&&a[2]<=i&&a[3]>=t){e.push([a,s])}}if(e.length==0){var v=this.ir(r,t,i);this.rr.push([new Date,r,t,i,v]);this.er(i-t+1);return await v}e[0][0][4].then((r=>{}));var l=0;if(e[0][0][2]>t){var c=this.ir(r,t,e[0][2]-1);l+=e[0][2]-t;this.rr[e[0][1]][0]=new Date;this.rr[e[0][1]][2]=t;this.rr[e[0][1]][4]=Promise.all([c,this.rr[e[0][1]][4]]).then((r=>r[0].concat(r[1])))}if(e.length>=2){for(var s=1;s<e.length;s++){var u=this.ir(r,this.rr[e[s-1][1]][3]+1,e[s][0][2]-1);l+=e[s][0][2]-this.rr[e[s-1][1]][3]-1;this.rr[e[0][1]][0]=new Date;this.rr[e[0][1]][3]=e[s][0][3];this.rr[e[0][1]][4]=u.then((r=>this.rr[e[0][1]][4].concat(r)));this.rr[e[0][1]][4]=Promise.all([this.rr[e[0][1]][4],e[s][0][4]]).then((r=>r[0].concat(r[1])))}}if(e[e.length-1][0][3]<i){var c=this.ir(r,e[e.length-1][0][3]+1,i);l+=i-e[e.length-1][0][3];this.rr[e[0][1]][0]=new Date;this.rr[e[0][1]][3]=i;this.rr[e[0][1]][4]=Promise.all([this.rr[e[0][1]][4],c]).then((r=>r[0].concat(r[1])))}if(e.length>=2){for(var s=1;s<e.length;s++){var f=this.rr.indexOf(e[s][0]);this.rr.splice(f,1)}}this.er(l);return this.loadSeq(r,t,i)}sr(r,t,i,e){var s=(r-1)%i;var a=(r-1-s)/i;return t+e*a+s}ir(r,t,i){return this.Z.then((e=>{const s=e.find((t=>t[0]==r));if(typeof s==="undefined"){throw"Chromosome ("+r+") is not found in faindex."}if(t<1||i>s[1]){throw"out of bounds"}var a=this.sr(t,s[2],s[3],s[4]);var n=this.sr(i,s[2],s[3],s[4]);return this.N.load(a,n-a+1)})).then((r=>{var t=String.fromCharCode.apply("",new Uint8Array(r));return t.replace(/\r?\n/g,"")}))}tr(r){var t=new String("");for(var i=0;i<r.length;i++){t=this.O[r.charAt(i)].concat(t)}return t}er(r){this.rr.sort(((r,t)=>r[0]-t[0]));while(r>=this.rr[0][3]-this.rr[0][2]+1){r-=this.rr[0][3]-this.rr[0][2]+1;this.rr.splice(0,1)}this.rr[0][2]+=r;this.rr[0][4]=this.rr[0][4].then((t=>t.slice(r)))}J(){return this.X.load().then((r=>{var t=[];var i=String.fromCharCode.apply("",new Uint8Array(r));var e=i.split("\n");e.forEach((r=>{var i=r.split("\t");if(i.length==5){t.push([i[0],parseInt(i[1],10),parseInt(i[2],10),parseInt(i[3],10),parseInt(i[4],10)])}}));return t}))}}
