class CramReader{constructor(r,t,e,i,s){if(!window.Worker){throw"Web Workers API is needed"}if(!r||!t){throw"Files are Falsy"}this.i=new Map;this.o=new Worker("cram-reader-worker.min.js");this.o.onmessage=function(r){var t=this.i.get(r.data[0]);this.i.delete(r.data[0]);if(t){t(r.data[1])}};this.u("init",[r,t,e,i,s],undefined)}getRecords(r,t,e,i){if(i){this.o.onmessage=function(r){i(r)}}this.u("read",[r,t,e],i)}u(r,t,e){var i=this.l();this.i.set(i,e);this.o.postMessage([i,r,t])}l(){var r="RRRRRRRR-RRRR-4RRR-rRRR-RRRRRRRRRRRR";for(var t=0;t<r.length;t++){switch(r.charAt(t)){case"R":r=r.replace("R",Math.floor(Math.random()*16).toString(16));break;case"r":r=r.replace("r",(Math.floor(Math.random()*4)+8).toString(16));break}}return r}}class Cram{constructor(r,t,e,i,s){if(!r||!t){throw"Files are Falsy"}this.p=e;this.F=new FileHandler(r,e);this.P=new FileHandler(t,e);this.I=undefined;if(i&&s){this._=true;var a=new FileHandler(i,e);var n=new FileHandler(s,e);this.S=new Fasta(a,n)}else{this._=false}this.U=new Map}getRecords(r,t,e){if(typeof this.I==="undefined"){this.I=this.q()}return new Promise(((i,s)=>{var a;var n=new CramHeader(this.F);var h=n.loadChrList().then((t=>{a=t;return t.indexOf(r)})).catch((r=>{s(r)}));var o=[];var f=[];Promise.all([this.I,h]).then((r=>{var i=r[0];var s=r[1];var a=[];i.forEach((r=>{if(r[0]==s&&r[1]<=e&&r[1]+r[2]>=t){var i=this.W(r).then((r=>{var i=this.j(s,t,e,r);o.push(i)}));a.push(i)}}));return a})).then((r=>Promise.all(r).then((()=>{o.forEach((r=>{f=f.concat(r)}));var r=[];f.forEach((t=>{r.push(this.L(a,t))}));return r})).catch((r=>{s(r)})))).then((r=>{Promise.all(r).then((()=>{i(f)})).catch((r=>{s(r)}))})).catch((r=>{s(r)}))}))}q(){return this.P.load().then((r=>{var t=[];var e=new Uint8Array(r);var i;try{var s=new Zlib.Gunzip(e);i=s.decompress()}catch(r){if(r.toString().includes("invalid file signature")){console.log("The crai file may be wrong, or a meddlesome browser may have unzipped it.");i=e}else{console.error(r)}}var a=String.fromCharCode.apply("",i);var n=a.split("\n");n.forEach((r=>{var e=r.split("\t");if(e.length==6){t.push([parseInt(e[0],10),parseInt(e[1],10),parseInt(e[2],10),parseInt(e[3],10),parseInt(e[4],10),parseInt(e[5],10)])}}));return t}))}W(r){var t=this.N(r[3]);var e=t.then((t=>this.X(r,t)));return Promise.all([t,e]).then((r=>{var t=new CramSlice(r[0],r[1]);return t.loadRecords()}))}N(r){return new Promise(((t,e)=>{if(this.U.has(r)){t(this.U.get(r))}var i=new CramDataContainer(this.F,r);this.U.set(r,i);t(i)}))}X(r,t){return t.loadHeaderLength().then((t=>{const e=r[3]+t+r[4];const i=r[5];return this.F.load(e,i)}))}j(r,t,e,i){var s=[];i.forEach((i=>{if(i.refSeqId==r&&i.position<=e&&i.position+i.readLength>=t){s.push(i)}}));return s}async L(r,t){t.refSeqName=r[t.refSeqId];t.restoreCigar();if(this._){await t.restoreSequence(this.S)}t.samString=t.toSAMString()}}class FileHandler{constructor(r,t=true){this.Z=r;this.p=t}load(r=-1,t=-1){return new Promise(((e,i)=>{if(this.p){if(r>=0&&t>0){var s=this.Z.slice(r,r+t);e(s.arrayBuffer())}else{e(this.Z.arrayBuffer())}}else{var a=new XMLHttpRequest;a.open("GET",this.Z);if(r>=0&&t>0){a.setRequestHeader("Range","bytes="+r+"-"+(r+t-1))}a.responseType="arraybuffer";a.onload=function(r){const t=a.response;if(t){e(t)}else{i(a.statusText)}};a.onerror=function(){i("An error occurred during HTTP access")};a.onabort=function(){i("HTTP access is aborted.")};a.timeout=function(){i("HTTP access timed out.")};a.send()}}))}}class Fasta{constructor(r,t,e=0){if(!r||!t){throw"Files are Falsy"}this.J=r;this.O=t;this.$=undefined;this.rr={A:"T",T:"A",G:"C",C:"G",R:"Y",Y:"R",M:"K",K:"M",B:"V",V:"B",D:"H",H:"D",a:"t",t:"a",g:"c",c:"g",r:"y",y:"r",m:"k",k:"m",b:"v",v:"b",d:"h",h:"d"};this.tr=e;if(this.tr>0){this.er=[[new Date,"",1,e,new Promise((r=>{r("N".repeat(e))}))]]}}loadSequence(r,t,e,i="+"){return this.loadSeq(r,t,e).then((r=>{if(i!=="-"&&i!==-1){return r}else{return this.ir(r)}}))}async loadSeq(r,t,e){if(!this.er){return await this.sr(r,t,e)}var i=[];this.er.sort(((r,t)=>r[2]-t[2]));for(var s=0;s<this.er.length;s++){var a=this.er[s];if(a[1]==r&&a[2]<=t&&a[3]>=e){this.er[s][0]=new Date;var n=t-a[2];var h=n+(e-t)+1;var o=await a[4];return o.slice(n,h)}else if(a[1]==r&&a[2]<=e&&a[3]>=t){i.push([a,s])}}if(i.length==0){var f=this.sr(r,t,e);this.er.push([new Date,r,t,e,f]);this.ar(e-t+1);return await f}i[0][0][4].then((r=>{}));var v=0;if(i[0][0][2]>t){var u=this.sr(r,t,i[0][2]-1);v+=i[0][2]-t;this.er[i[0][1]][0]=new Date;this.er[i[0][1]][2]=t;this.er[i[0][1]][4]=Promise.all([u,this.er[i[0][1]][4]]).then((r=>r[0].concat(r[1])))}if(i.length>=2){for(var s=1;s<i.length;s++){var c=this.sr(r,this.er[i[s-1][1]][3]+1,i[s][0][2]-1);v+=i[s][0][2]-this.er[i[s-1][1]][3]-1;this.er[i[0][1]][0]=new Date;this.er[i[0][1]][3]=i[s][0][3];this.er[i[0][1]][4]=c.then((r=>this.er[i[0][1]][4].concat(r)));this.er[i[0][1]][4]=Promise.all([this.er[i[0][1]][4],i[s][0][4]]).then((r=>r[0].concat(r[1])))}}if(i[i.length-1][0][3]<e){var u=this.sr(r,i[i.length-1][0][3]+1,e);v+=e-i[i.length-1][0][3];this.er[i[0][1]][0]=new Date;this.er[i[0][1]][3]=e;this.er[i[0][1]][4]=Promise.all([this.er[i[0][1]][4],u]).then((r=>r[0].concat(r[1])))}if(i.length>=2){for(var s=1;s<i.length;s++){var d=this.er.indexOf(i[s][0]);this.er.splice(d,1)}}this.ar(v);return this.loadSeq(r,t,e)}nr(r,t,e,i){var s=(r-1)%e;var a=(r-1-s)/e;return t+i*a+s}sr(r,t,e){if(typeof this.$==="undefined"){this.$=this.hr()}return this.$.then((i=>{const s=i.find((t=>t[0]==r));if(typeof s==="undefined"){throw"Chromosome ("+r+") is not found in faindex."}if(t<1||e>s[1]){throw"out of bounds"}var a=this.nr(t,s[2],s[3],s[4]);var n=this.nr(e,s[2],s[3],s[4]);return this.J.load(a,n-a+1)})).then((r=>{var t=String.fromCharCode.apply("",new Uint8Array(r));return t.replace(/\r?\n/g,"")}))}ir(r){var t=new String("");for(var e=0;e<r.length;e++){t=this.rr[r.charAt(e)].concat(t)}return t}ar(r){this.er.sort(((r,t)=>r[0]-t[0]));while(r>=this.er[0][3]-this.er[0][2]+1){r-=this.er[0][3]-this.er[0][2]+1;this.er.splice(0,1)}this.er[0][2]+=r;this.er[0][4]=this.er[0][4].then((t=>t.slice(r)))}hr(){return this.O.load().then((r=>{var t=[];var e=String.fromCharCode.apply("",new Uint8Array(r));var i=e.split("\n");i.forEach((r=>{var e=r.split("\t");if(e.length==5){t.push([e[0],parseInt(e[1],10),parseInt(e[2],10),parseInt(e[3],10),parseInt(e[4],10)])}}));return t}))}}
