class BitsIO{constructor(t){this.t=new Uint8Array(t),this.i=0,this.s=0,this.h=0,this.o()}read(t){for(var i=0,s=t;s>0;)i+=this.u()*2**(s-1),s-=1;return i}u(){const t=(this.s&2**this.h)>>this.h;return 0==this.h?this.o():this.h-=1,t}o(){this.s=this.t[this.i],this.i+=1,this.h=7}}class Cram{constructor(t,i,s,r,e){if(!t||!i)throw"Files are Falsy";if(this.v=s,this.I=new FileHandler(t,s),this.l=new FileHandler(i,s),this.g=this.S(),r&&e){this.m=!0;var n=new FileHandler(r,s),a=new FileHandler(e,s);this.C=new Fasta(n,a)}else this.m=!1;this.B=new Map}getRecords(t,i,s){return new Promise((r,e)=>{var n,a=new CramHeader(this.I).p().then(i=>(n=i,i.indexOf(t))).catch(t=>{e(t)}),h=[],o=[];Promise.all([this.g,a]).then(t=>{var r=t[0],e=t[1],n=[];return r.forEach(t=>{if(t[0]==e&&t[1]<=s&&t[1]+t[2]>=i){var r=this.A(t).then(t=>{var r=this.F(e,i,s,t);h.push(r)});n.push(r)}}),n}).then(t=>Promise.all(t).then(()=>{h.forEach(t=>{o=o.concat(t)});var t=[];return o.forEach(i=>{t.push(this.D(n,i))}),t}).catch(t=>{e(t)})).then(t=>{Promise.all(t).then(()=>{r(o)}).catch(t=>{e(t)})}).catch(t=>{e(t)})})}S(){return this.l.load().then(t=>{var i,s=[],r=new Uint8Array(t);try{i=new Zlib.Gunzip(r).decompress()}catch(t){t.toString().includes("invalid file signature")?(console.log("The crai file may be wrong, or a meddlesome browser may have unzipped it."),i=r):console.error(t)}return String.fromCharCode.apply("",i).split("\n").forEach(t=>{var i=t.split("\t");6==i.length&&s.push([parseInt(i[0],10),parseInt(i[1],10),parseInt(i[2],10),parseInt(i[3],10),parseInt(i[4],10),parseInt(i[5],10)])}),s})}A(t){var i=this.R(t[3]),s=i.then(i=>this.M(t,i));return Promise.all([i,s]).then(t=>new CramSlice(t[0],t[1]).P())}R(t){return new Promise((i,s)=>{this.B.has(t)&&i(this.B.get(t));var r=new CramDataContainer(this.I,t);this.B.set(t,r),i(r)})}M(t,i){return i._().then(i=>{const s=t[3]+i+t[4],r=t[5];return this.I.load(s,r)})}F(t,i,s,r){var e=[];return r.forEach(r=>{r.refSeqId==t&&r.position<=s&&r.position+r.readLength>=i&&e.push(r)}),e}async D(t,i){i.refSeqName=t[i.refSeqId],i.N(),this.m&&await i.k(this.C)}}class CramContainer{constructor(t,i){this.H=t,this.U=i,this.T=void 0,this.O=52,this.L=void 0,this.q=void 0,this.V=void 0}G(){return this.U}_(){return void 0===this.V&&(this.V=this.X()),this.V}X(){return this.H.load(this.U,this.O).then(t=>{this.T=new CramStream(t),this.length=this.T.Z(),this.K=this.T.Y(),this.J=this.T.Y(),this.j=this.T.Y(),this.W=this.T.Y(),this.$=this.T.tt(),this.it=this.T.tt(),this.st=this.T.Y(),this.rt=this.T.Y();var i=this.O-this.T.et();if(this.L=5*this.rt+4-i,this.L>0)return this.H.load(this.U+this.O,this.L);this.L=0}).then(t=>{t&&this.T.concat(t);for(var i=[],s=0;s<this.rt;s++)i.push(this.T.Y());return this.nt=i,this.at=this.T.ht(),this.T.et()})}}class CramDataContainer extends CramContainer{constructor(t,i){super(t,i),this.ot=void 0,this.V=this.X()}ct(){return this.ot?this.ot:(this.ot=this.V.then(t=>{this.q=this.nt[0]+t-this.O-this.L}).then(()=>this.H.load(this.U+this.O+this.L,this.q)).then(t=>(this.T.concat(t),this.dt())),this.ot)}async dt(){var t=await this.V,i=this.T.wt(t),s=new Map;const r=i.get("IO");{s.set("pm",new Map),s.get("pm").set("RN",!0),s.get("pm").set("AP",!0),s.get("pm").set("RR",!0);r.Y();const t=r.Y();for(var e=0;e<t;e++){const t=String.fromCharCode.apply("",new Uint8Array(r.read(2)));if("RN"==t||"AP"==t||"RR"==t)n=r.ut();else if("SM"==t)n=r.read(5);else{if("TD"!=t)continue;n=this.ft(r.vt())}s.get("pm").set(t,n)}}{s.set("dse",new Map);r.Y();const t=r.Y();for(e=0;e<t;e++){const t=String.fromCharCode.apply("",new Uint8Array(r.read(2)));var n;if(["BF","CF","RI","RL","AP","RG","MF","NS","NP","TS","NF","TL","FN","FP","DL","RS","PD","HC","MQ"].includes(t))n=r.It();else if(["RN","BB","QQ","IN","SC"].includes(t))n=r.lt();else{if(!["FC","BS","BA","QS"].includes(t))continue;n=r.gt()}s.get("dse").set(t,n)}}{s.set("tv",new Map);r.Y();const t=r.Y();for(e=0;e<t;e++){const t=r.Y(),i=String.fromCharCode((16711680&t)>>16,(65280&t)>>8,255&t),e=r.lt();s.get("tv").set(i,e)}}return i.set("content",s),i}ft(t){for(var i=new Int8Array(t),s=[],r=0;r+2<t.byteLength;){for(var e=[];i[r]!="\0".charCodeAt(0);){var n=String.fromCharCode(i[r],i[r+1]),a=String.fromCharCode(i[r+2]);e.push(n+a),r+=3}s.push(e),r+=1}return s}}class CramHeader extends CramContainer{constructor(t){super(t,26),this.St=void 0,this.yt=void 0,this.Ct=26,this.Bt=23,this.O=this.Ct+this.Bt,this.V=this.X()}p(){return void 0!==this.yt?this.yt:(this.yt=this.V.then(t=>{var i=this.T.wt(this.U+t),s=i.get("IO").pt(i.get("rawSize")),r=[];return s.split("\n").forEach(t=>{var i=t.split(RegExp(/\t|:/));"@SQ"==i[0]&&r.push(i[i.indexOf("SN")+1])}),r}),this.yt)}X(){var t=this.H.load(0,this.O).then(t=>{this.T=new CramStream(t);var i=this.T.pt(4),s=new Uint8Array(this.T.read(2));if("CRAM"!==i||3!==s[0]||0!==s[1])throw"[invalid file signature] This file is not CRAM 3.0 file.";return this.St=this.T.pt(20),this.length=this.T.Z(),this.K=this.T.Y(),this.J=this.T.Y(),this.j=this.T.Y(),this.W=this.T.Y(),this.$=this.T.tt(),this.it=this.T.tt(),this.st=this.T.Y(),this.nt=this.T.At(),this.at=this.T.ht(),this.T.et()-this.Ct}),i=t.then(t=>(this.L=t+this.nt[1]-this.Bt,this.H.load(this.O,this.L)));return Promise.all([t,i]).then(t=>(this.T.concat(t[1]),t[0]))}}class CramRans{constructor(t){this.Ft=new CramStream(t)}bt(){const t=this.Ft.Dt(),i=(this.Ft.ht(),this.Ft.ht());var s=new Uint8Array(i);return 0==t?this.Rt(s,i):this.Mt(s,i),s.buffer}Pt(t,i){for(var s=this.Ft._t(),r=s,e=0;;){var n=this.Ft.Y();if(t[s]=n,e>0?(e-=1,s+=1):(s=this.Ft._t())==r+1&&(e=this.Ft._t()),r=s,0==s||256==s)break}i[0]=0;for(var a=0;a<255;a++)i[a+1]=i[a]+t[a]}Nt(t){return 4095&t}kt(t,i){for(var s=0;s+1<t.length&&i>=t[s+1];)s+=1;return s}Ht(t,i,s){return s*(t>>12)+(4095&t)-i}Ut(t){for(;t<1<<23;)t=(t<<8)+this.Ft._t();return t}Rt(t,i){var s=new Array(256).fill(0),r=new Array(256).fill(0),e=new Array(4).fill(0);this.Pt(s,r);for(var n=0;n<4;n++)e[n]=this.Ft.ht();for(var a=0;a<i;){for(n=0;n<4;n++){if(a+n>=i)return;var h=this.Nt(e[n]),o=this.kt(r,h);t[a+n]=o,e[n]=this.Ht(e[n],r[o],s[o]),e[n]=this.Ut(e[n])}a+=4}}Tt(t,i){for(var s=this.Ft._t(),r=s,e=0;this.Pt(t[s],i[s]),e>0?(e-=1,s+=1):(s=this.Ft._t())==r+1&&(e=this.Ft._t()),r=s,0!=s&&256!=s;);}Mt(t,i){var s=Array.from(new Array(256),()=>new Array(256).fill(0)),r=Array.from(new Array(256),()=>new Array(256).fill(0)),e=new Array(4).fill(0),n=new Array(4).fill(0);this.Tt(s,r);for(var a=0;a<4;a++)e[a]=this.Ft.ht(),n[a]=0;for(var h=0;h<i/4;){for(a=0;a<4;a++){var o=this.Nt(e[a]),c=this.kt(r[n[a]],o);t[h+Math.floor(a*i/4)]=c,e[a]=this.Ht(e[a],r[n[a]][c],s[n[a]][c]),e[a]=this.Ut(e[a]),n[a]=c}h+=1}for(h*=4;h<i;)o=this.Nt(e[3]),c=this.kt(r[n[3]],o),t[h+Math.floor(3*i/4)]=c,e[3]=this.Ht(e[3],r[n[3]][c],s[n[3]][c]),e[3]=this.Ut(e[3]),n[3]=c,h+=1;return t}}class CramRecord{constructor(t,i){this.bf_=t,this.cf_=i,this.features_=new Array}Qt(){return this.bf_}Ot(){return this.cf_}Lt(t){this.bf_=t}xt(t){this.features_.push(t)}toSAMString(){var t=new String;return t+=void 0===this.readName?"":this.readName,t+="\t"+(void 0===this.bf_?"":this.bf_),t+="\t"+(void 0===this.refSeqName?"":this.refSeqName),t+="\t"+(void 0===this.position?"":this.position),t+="\t"+(void 0===this.mappingQuality?"":this.mappingQuality),t+="\t"+(void 0===this.cigar?"":this.cigar),t+="\t"+(void 0===this.mateReadName?"":this.mateReadName),t+="\t"+(void 0===this.matePos?"":this.matePos),t+="\t"+(void 0===this.templateSize?"":this.templateSize),t+="\t"+(void 0===this.seq?"":this.seq)+"\t",t+="\t"+(void 0===this.qualityScore?"":this.qualityScore),t+="\t"+(void 0===this.tags?"":JSON.stringify(this.tags))}qt(){return this.features_.forEach(t=>{if("S"==t.get("FC"))return!0}),!1}N(){if(this.Et(),!("cigar"in this)&&"readLength"in this)if(0!=this.features_.length){var t="",i=[],s=[""],r="",e=0,n=1;this.features_.forEach(t=>{var a=t.get("FP")-(n+e);switch(a>0&&("M"==r?i[i.length-1]+=a:(i.push(a),s.push("M"),r="M")),n=t.get("FP"),t.get("FC")){case"X":e=1,"M"==(r="M")?i[i.length-1]++:(i.push(1),s.push("M"));break;case"S":e=t.get("SC").length,r="S",i.push(e),s.push("S");break;case"i":e=1,r="I",i.push(1),s.push("I");break;case"I":e=t.get("IN").length,r="I",i.push(t.get("IN").length),s.push("I");break;case"D":e=0,r=t.get("FC"),i.push(t.get("DL")),s.push(t.get("FC"));break;case"N":e=0,r=t.get("FC"),i.push(t.get("RS")),s.push(t.get("FC"));break;case"P":e=0,r=t.get("FC"),i.push(t.get("PD")),s.push(t.get("FC"));break;case"H":e=0,r=t.get("FC"),i.push(t.get("HC")),s.push(t.get("FC"))}}),n+e-1<this.readLength&&("M"==r?i[i.length-1]+=this.readLength-(n+e-1):(i.push(this.readLength-(n+e-1)),s.push("M")));for(var a=0;a<i.length;a++)t+=String(i[a])+s[a+1];this.cigar=t}else this.cigar=String(this.readLength)+"M"}Et(){this.features_.sort((t,i)=>t.get("FP")-i.get("FP"))}k(t){this.Et();this.readLength;for(var i=[],s=0,r=this.position,e=0,n=0;n<this.features_.length+1;n++){var a="",h=this.readLength;n<this.features_.length&&(a=this.features_[n].get("FC"),h=this.features_[n].get("FP")),e+=h-s,s=h,"I"!=a?"i"!=a?"S"!=a?"D"!=a&&"N"!=a&&n!=this.features_.length||(i.push(t.Vt(this.refSeqName,r,r+e-1)),"D"==a&&(e+=this.features_[n].get("DL")),"N"==a&&(e+=this.features_[n].get("RS")),r+=e,e=0):this.features_[n].get("SC").length:0:this.features_[n].get("IN").length}return Promise.all(i).then(t=>{var i="";return t.forEach(t=>{i=i.concat(t)}),this.features_.forEach(t=>{var s=t.get("FP");switch(t.get("FC")){case"I":var r=i.slice(0,s-1),e=i.slice(s-1),n=String.fromCharCode.apply("",new Uint8Array(t.get("IN")));i=r+n+e;break;case"i":r=i.slice(0,s-1),e=i.slice(s-1),n=String.fromCharCode.apply("",new Uint8Array(t.get("BA")));i=r+n+e;break;case"S":r=i.slice(0,s-1),e=i.slice(s-1),n=String.fromCharCode.apply("",new Uint8Array(t.get("SC")));i=r+n+e;break;case"X":for(var a=i.slice(s-1,s).toUpperCase(),h="ACGTN".indexOf(a),o=new Uint8Array(t.get("SM")).slice(h,h+1)[0],c="ACGTN".replace(a,""),d=new Uint8Array(t.get("BS"))[0],w="x",u=0;u<4;u++)(o>>2*(3-u)&3)==d&&(w=c.charAt(u));r=i.slice(0,s-1),e=i.slice(s);i=r+w+e}}),this.seq=i.toUpperCase(),this.seq})}}class CramSlice{constructor(t,i){this.zt=t,this.T=new CramStream(i),this.Gt=void 0,this.Xt=[]}async P(){this.Zt(),this.Kt(),this.Xt[0].set("IO",new BitsIO(this.Xt[0].get("IO").arrayBuffer()));const t=this.Gt.get("content").get("numberOfRecords");for(var i=[],s=0;s<t;s++){var r=await this.Yt("BF","Int"),e=await this.Yt("CF","Int"),n=new CramRecord(r,e);await this.Jt(n),await this.jt(n),await this.Wt(n),await this.$t(n),0==(4&n.Qt())?await this.ti(n):await this.ii(n),i.push(n)}return this.si(i),i}Zt(){var t=this.T.wt(0),i=t.get("IO");return t.set("content",new Map),t.get("content").set("refSeqId",i.Y()),t.get("content").set("alignmentStart",i.Y()),t.get("content").set("alignmentSpan",i.Y()),t.get("content").set("numberOfRecords",i.Y()),t.get("content").set("recordCounter",i.Y()),t.get("content").set("numberOfBlocks",i.Y()),t.get("content").set("blockContentIds",i.At()),t.get("content").set("embeddedRefBasesBlockContentId",i.Y()),t.get("content").set("refMD5",i.read(16)),this.Gt=t,t}Kt(){const t=1+this.Gt.get("content").get("blockContentIds").length;var i=[];this.T.ri(this.Gt.get("blockSize"));for(var s=0;s<t;s++){var r=this.T.wt();i.push(r)}return this.Xt=i,i}async Yt(t,i){var s=(await this.zt.ct()).get("content").get("dse").get(t);return this.ei(s,i)}ei(t,i){var s=t.get("codecId");if(1==s){var r=this.ni(t.get("externalId")).get("IO");if("Int"==i)return r.Y();if("Byte"==i)return r.read(1);throw"type "+i+" is not supported. (codecId: 1)"}if(3==s){const i=t.get("alphabet"),s=t.get("bit-length");if(1==s.length&&0==s[0])return i[0];throw"HUFFMAN decoding is in the process of being implemented."}if(5!=s){if(6==s)return this.Xt[0].get("IO").read(t.get("length"))-t.get("offset");throw"codecId: "+str(s)+" is not supported."}{r=this.ni(t.get("externalId")).get("IO");var e=[];const i=new CramStream(t.get("stopByte"))._t();for(;;){var n=r._t();if(n==i)return e;e.push(n)}}}ni(t){var i=this.Gt.get("content").get("blockContentIds").indexOf(t);return this.Xt[i+1]}async Jt(t){if(-2==this.Gt.get("content").get("refSeqId")?t.refSeqId=await this.Yt("RI","Int"):t.refSeqId=this.Gt.get("content").get("refSeqid"),t.readLength=await this.Yt("RL","Int"),0!=(await this.zt.ct()).get("content").get("pm").get("AP")){void 0===this.ai&&(this.ai=this.Gt.get("content").get("alignmentStart"));var i=await this.Yt("AP","Int");t.position=i+this.ai,this.ai=t.position}else{i=await this.Yt("AP","Int");t.position=i}t.readGroup=await this.Yt("RG","Int")}async jt(t){if((await this.zt.ct()).get("content").get("pm").get("RN")){var i=await this.Yt("RN","ByteArray"),s="";i.forEach(t=>{s+=String.fromCharCode(t)}),t.readName=s}else t.readName=this.hi(t)}hi(t){return generatedName="generatedName"+String(t.refSeqId)+"."+String(t.position),generatedName}async Wt(t){if(2==(2&t.Ot())){const i=await this.Yt("MF","Int");1==(1&i)&&t.Lt(32|t.Qt()),2==(2&i)&&t.Lt(8|t.Qt()),(await this.zt.ct()).get("content").get("pm").get("RN")||(rn=await this.Yt("RN","ByteArray"),t.readName=String(rn)),t.mateRefId=await this.Yt("NS","Int"),t.matePos=await this.Yt("NP","Int"),t.templateSize=await this.Yt("TS","Int")}else 4==(4&t.Ot())&&(t.oi=await this.Yt("NF","Int"))}async $t(t){const i=await this.Yt("TL","Int");var s=await this.zt.ct(),r={};const e=t=>{t.slice(0,2);const i=t.slice(-1);var e,n=s.get("content").get("tv").get(t).get("valuesEncoding");if("A"==i)e=this.ei(n,"Char");else if("c"==i||"C"==i||"s"==i||"S"==i||"i"==i||"I"==i)e=this.ei(n,"Int");else if("f"==i)e=this.ei(n,"float32");else if("Z"==i)e=this.ei(n,"String");else if("H"==i)e=this.ei(n,"Hstring");else{if("B"!=i)return void console.error("tagType'"+String(i)+"' is not supported.");e=this.ei(n,"ByteArray")}r[t]=e};for(var n of s.get("content").get("pm").get("TD")[i])e(n);t.tags=r}async ti(t){const i=await this.Yt("FN","Int");for(var s=0;s<i;s++)await this.ci(t);t.mappingQuality=await this.Yt("MQ","Int"),(await this.zt.ct()).get("content").get("dse").has("QS")&&(t.qualityScore=await this.di(t.readLength))}async ci(t){var i=new Map,s=await this.Yt("FC","Byte");if(i.set("FC",String.fromCharCode.apply("",new Uint8Array(s))),i.set("FP",await this.Yt("FP","Int")),"B"==i.get("FC"))i.set("BA",await this.Yt("BA","Byte")),i.set("QS",await this.Yt("QS","Byte"));else if("X"==i.get("FC")){i.set("BS",await this.Yt("BS","Byte"));var r=await this.zt.ct();i.set("SM",r.get("content").get("pm").get("SM"))}else"I"==i.get("FC")?i.set("IN",await this.Yt("IN","ByteArray")):"S"==i.get("FC")?i.set("SC",await this.Yt("SC","ByteArray")):"H"==i.get("FC")?i.set("HC",await this.Yt("HC","Int")):"P"==i.get("FC")?i.set("PD",await this.Yt("PD","Int")):"D"==i.get("FC")?i.set("DL",await this.Yt("DL","Int")):"N"==i.get("FC")?i.set("RS",await this.Yt("RS","Int")):"i"==i.get("FC")?i.set("BA",await this.Yt("BA","Byte")):"b"==i.get("FC")?i.set("BB",await this.Yt("BB","ByteArray")):"q"==i.get("FC")?i.set("QQ",await this.Yt("QQ","ByteArray")):"Q"==i.get("FC")&&i.set("QS",await this.Yt("QS","Byte"));t.xt(i)}async ii(t){b=new Array(t.readLength);for(var i=0;i<t.readLength;i++)b[i]=await this.Yt("BA","Byte");t.wi=b,(await this.zt.ct()).get("content").get("dse").has("QS")&&(t.qualityScore=await this.di(t.readLength))}async di(t){for(var i=new Array(t),s=0;s<t;s++){var r=await this.Yt("QS","Int");i[s]=r+33}return String.fromCharCode.apply("",i)}si(t){for(var i=0;i<t.length;i++){var s=t[i];if(4==(4&s.Ot())){var r=t[i+s.oi+1];if(16==(16&r.Qt())&&s.Lt(32|s.Qt()),4==(4&r.Qt())&&s.Lt(8|s.Qt()),s.mateReadName=r.readName,r.mateReadName=s.readName,s.mateRefId=r.refSeqId,r.mateRefId=s.refSeqId,s.matePos=r.position,r.matePos=s.position,s.refSeqId!=r.refSeqId)return s.templateSize=0,void(r.templateSize=0);var e=s.readLength-(s.qt()?s.ui.get("S").length:0),n=r.readLength-(r.qt()?r.ui.get("S").length:0),a=[s.position,s.position+(16!=(16&s.Qt())?e-1:1-e),r.position,r.position-(16!=(16&r.Qt())?n-1:1-n)],h=Math.min(...a),o=Math.max(...a),c=a.indexOf(h)<2?s:r,d=a.indexOf(o)<2?s:r;c.templateSize=o-h+1,d.templateSize=-(o-h+1)}}}}class CramStream{constructor(t){if(!t)throw"[CramStream] Invalid argument: arrbuf is undefined (falsy)";this.fi=t,this.g=0}arrayBuffer(){return this.fi}concat(t){var i=new Uint8Array(this.fi.byteLength+t.byteLength);i.set(new Uint8Array(this.fi),0),i.set(new Uint8Array(t),this.fi.byteLength),this.fi=i.buffer}et(){return this.g}ri(t){this.g=t}read(t){const i=this.fi.slice(this.g,this.g+t);return this.g+=t,i}Dt(){return new DataView(this.read(1)).getInt8(0)}vi(){return new DataView(this.read(2)).getInt16(0,!0)}Z(){return new DataView(this.read(4)).getInt32(0,!0)}Ii(){return new DataView(this.read(8)).getBigInt64(0,!0)}_t(){const t=new DataView(this.read(1));return t.byteLength<1?0:t.getUint8(0)}li(){return new DataView(this.read(2)).getUint16(0,!0)}ht(){return new DataView(this.read(4)).getUint32(0,!0)}gi(){return new DataView(this.read(8)).getBigUint64(0,!0)}ut(){return 1==new DataView(this.read(1)).getInt8(0,!0)}Si(){return String.fromCharCode.apply("",new Uint8Array(this.read(1)))}pt(t){return String.fromCharCode.apply("",new Uint8Array(this.read(t)))}Y(){const t=this._t();if(t>>7==0)return 127&t;if(t>>6==2){return(63&t)<<8|this._t()}if(t>>5==6){return(31&t)<<16|this._t()<<8|this._t()}if(t>>4==14){return(15&t)<<24|this._t()<<16|this._t()<<8|this._t()}{const i=(15&t)<<28|this._t()<<20|this._t()<<12|this._t()<<4|15&this._t();return i<2**31?i:i-2**32}}tt(){const t=BigInt(this._t());if(t>>7n==0b0n)return 0b01111111n&t;if(t>>6n==0b10n){return(0b00111111n&t)<<8n|BigInt(this.Dt())}if(t>>5n==0b110n){return(0b00011111n&t)<<16n|BigInt(this._t())<<8n|BigInt(this._t())}if(t>>4n==0b1110n){return(0b00001111n&t)<<24n|BigInt(this._t())<<16n|BigInt(this._t())<<8n|BigInt(this._t())}if(t>>3n==0b11110n){return(0b00000111n&t)<<32n|BigInt(this._t())<<24n|BigInt(this._t())<<16n|BigInt(this._t())<<8n|BigInt(this._t())}if(t>>2n==0b111110n){return(0b00000011n&t)<<40n|BigInt(this._t())<<32n|BigInt(this._t())<<24n|BigInt(this._t())<<16n|BigInt(this._t())<<8n|BigInt(this._t())}if(t>>1n==0b1111110n){return(0b00000001n&t)<<48n|BigInt(this._t())<<40n|BigInt(this._t())<<32n|BigInt(this._t())<<24n|BigInt(this._t())<<16n|BigInt(this._t())<<8n|BigInt(this._t())}if(0b11111110n==t){return BigInt(this._t())<<48n|BigInt(this._t())<<40n|BigInt(this._t())<<32n|BigInt(this._t())<<24n|BigInt(this._t())<<16n|BigInt(this._t())<<8n|BigInt(this._t())}return this.Ii()}At(){var t=[];const i=this.Y();for(var s=0;s<i;s++)t.push(this.Y());return t}vt(){const t=this.Y();return this.read(t)}It(){var t=new Map;t.set("codecId",this.Y());this.Y();return 1==t.get("codecId")?(t.set("externalId",this.Y()),t):3==t.get("codecId")?(t.set("alphabet",this.At()),t.set("bit-length",this.At()),t):6==t.get("codecId")?(t.set("offset",this.Y()),t.set("length",this.Y()),t):7==t.get("codecId")?(t.set("offset",this.Y()),t.set("k",readItf8()),t):9==t.get("codecId")?(t.set("offset",readItf8()),t):(console.log("Error: invalid codec ID"),t)}gt(){var t=new Map;t.set("codecId",this.Y());this.Y();return 1==t.get("codecId")?(t.set("externalId",this.Y()),t):3==t.get("codecId")?(t.set("alphabet",this.At()),t.set("bit-length",this.At()),t):(console.log("Error: invalid codec ID"),t)}lt(){var t=new Map;t.set("codecId",this.Y());this.Y();return 4==t.get("codecId")?(t.set("lengthsEncoding",this.It()),t.set("valuesEncoding",this.gt()),t):5==t.get("codecId")?(t.set("stopByte",this.read(1)),t.set("externalId",this.Y()),t):(console.log("Error: invalid codec ID"),t)}wt(t=-1){var i=new Map;t>=0&&this.ri(t);const s=this.et();i.set("method",this.Dt()),i.set("contentTypeId",this.Dt()),i.set("contentId",this.Y()),i.set("size",this.Y()),i.set("rawSize",this.Y());const r=this.read(i.get("size"));var e;if(0==i.get("method"))e=r;else if(1==i.get("method")){var n=new Uint8Array(r);e=new Zlib.Gunzip(n).decompress().buffer}else{if(2==i.get("method"))throw"bzip2 is not supported";if(3==i.get("method"))throw"lzma is not supported";if(4!=i.get("method"))throw"unknown compression method";e=new CramRans(r).bt()}return i.set("IO",new CramStream(e)),i.set("CRC32",this.ht()),i.set("blockSize",this.et()-s),i}}class FileHandler{constructor(t,i=!0){this.H=t,this.v=i}load(t=-1,i=-1){return new Promise((s,r)=>{if(this.v)if(t>=0&&i>0){var e=this.H.slice(t,t+i);s(e.arrayBuffer())}else s(this.H.arrayBuffer());else{var n=new XMLHttpRequest;n.open("GET",this.H),t>=0&&i>0&&n.setRequestHeader("Range","bytes="+t+"-"+(t+i-1)),n.responseType="arraybuffer",n.onload=function(t){const i=n.response;i?s(i):r(n.statusText)},n.onerror=function(){r("An error occurred during HTTP access")},n.onabort=function(){r("HTTP access is aborted.")},n.timeout=function(){r("HTTP access timed out.")},n.send()}})}}class Fasta{constructor(t,i,s=0){if(!t||!i)throw"Files are Falsy";this.mi=t,this.yi=i,this.Ci=this.Bi(),this.pi={Ai:"T",Fi:"A",bi:"C",Di:"G",Ri:"Y",Mi:"R",Pi:"K",_i:"M",Ni:"V",ki:"B",Hi:"H",Ui:"D",a:"t",Ti:"a",Qi:"c",c:"g",r:"y",y:"r",Oi:"k",Li:"m",b:"v",xi:"b",d:"h",qi:"d"},this.Ei=s,this.Ei>0&&(this.Vi=[[new Date,"",1,s,new Promise(t=>{t("N".repeat(s))})]])}Vt(t,i,s,r="+"){return this.zi(t,i,s).then(t=>"-"!==r&&-1!==r?t:this.Gi(t))}async zi(t,i,s){if(!this.Vi)return await this.Xi(t,i,s);var r=[];this.Vi.sort((t,i)=>t[2]-i[2]);for(var e=0;e<this.Vi.length;e++){var n=this.Vi[e];if(n[1]==t&&n[2]<=i&&n[3]>=s){this.Vi[e][0]=new Date;var a=i-n[2],h=a+(s-i)+1;return(await n[4]).slice(a,h)}n[1]==t&&n[2]<=s&&n[3]>=i&&r.push([n,e])}if(0==r.length){var o=this.Xi(t,i,s);return this.Vi.push([new Date,t,i,s,o]),this.Zi(s-i+1),await o}r[0][0][4].then(t=>{});var c=0;if(r[0][0][2]>i){var d=this.Xi(t,i,r[0][2]-1);c+=r[0][2]-i,this.Vi[r[0][1]][0]=new Date,this.Vi[r[0][1]][2]=i,this.Vi[r[0][1]][4]=Promise.all([d,this.Vi[r[0][1]][4]]).then(t=>t[0].concat(t[1]))}if(r.length>=2)for(e=1;e<r.length;e++){var w=this.Xi(t,this.Vi[r[e-1][1]][3]+1,r[e][0][2]-1);c+=r[e][0][2]-this.Vi[r[e-1][1]][3]-1,this.Vi[r[0][1]][0]=new Date,this.Vi[r[0][1]][3]=r[e][0][3],this.Vi[r[0][1]][4]=w.then(t=>this.Vi[r[0][1]][4].concat(t)),this.Vi[r[0][1]][4]=Promise.all([this.Vi[r[0][1]][4],r[e][0][4]]).then(t=>t[0].concat(t[1]))}if(r[r.length-1][0][3]<s){d=this.Xi(t,r[r.length-1][0][3]+1,s);c+=s-r[r.length-1][0][3],this.Vi[r[0][1]][0]=new Date,this.Vi[r[0][1]][3]=s,this.Vi[r[0][1]][4]=Promise.all([this.Vi[r[0][1]][4],d]).then(t=>t[0].concat(t[1]))}if(r.length>=2)for(e=1;e<r.length;e++){var u=this.Vi.indexOf(r[e][0]);this.Vi.splice(u,1)}return this.Zi(c),this.zi(t,i,s)}Ki(t,i,s,r){var e=(t-1)%s;return i+r*((t-1-e)/s)+e}Xi(t,i,s){return this.Ci.then(r=>{const e=r.find(i=>i[0]==t);if(void 0===e)throw"Chromosome ("+t+") is not found in faindex.";if(i<1||s>e[1])throw"out of bounds";var n=this.Ki(i,e[2],e[3],e[4]),a=this.Ki(s,e[2],e[3],e[4]);return this.mi.load(n,a-n+1)}).then(t=>String.fromCharCode.apply("",new Uint8Array(t)).replace(/\r?\n/g,""))}Gi(t){for(var i=new String(""),s=0;s<t.length;s++)i=this.pi[t.charAt(s)].concat(i);return i}Zi(t){for(this.Vi.sort((t,i)=>t[0]-i[0]);t>=this.Vi[0][3]-this.Vi[0][2]+1;)t-=this.Vi[0][3]-this.Vi[0][2]+1,this.Vi.splice(0,1);this.Vi[0][2]+=t,this.Vi[0][4]=this.Vi[0][4].then(i=>i.slice(t))}Bi(){return this.yi.load().then(t=>{var i=[];return String.fromCharCode.apply("",new Uint8Array(t)).split("\n").forEach(t=>{var s=t.split("\t");5==s.length&&i.push([s[0],parseInt(s[1],10),parseInt(s[2],10),parseInt(s[3],10),parseInt(s[4],10)])}),i})}}