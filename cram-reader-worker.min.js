class BitsIO{constructor(t){this.t=new Uint8Array(t);this.i=0;this.h=0;this.o=0;this.u()}read(t){var i=0;var e=t;while(e>0){i+=this.v()*2**(e-1);e-=1}return i}v(){const t=(this.h&2**this.o)>>this.o;if(this.o==0){this.u()}else{this.o-=1}return t}u(){this.h=this.t[this.i];this.i+=1;this.o=7}}class CramContainer{constructor(t,i){this.l=t;this.I=i;this.S=undefined;this.g=4+5*4+9*2+5*2;this.B=undefined;this.C=undefined;this.m=undefined}getPosition(){return this.I}loadHeaderLength(){if(typeof this.m==="undefined"){this.m=this.A()}return this.m}A(){return this.l.load(this.I,this.g).then((t=>{this.S=new CramStream(t);this.length=this.S.readInt32();this.ref_id=this.S.readItf8();this.starting_ref_pos=this.S.readItf8();this.alignment_span=this.S.readItf8();this.number_records=this.S.readItf8();this.record_counter=this.S.readLtf8();this.bases=this.S.readLtf8();this.number_blocks=this.S.readItf8();this.p=this.S.readItf8();var i=this.g-this.S.tell();this.B=5*this.p+4-i;if(this.B>0){return this.l.load(this.I+this.g,this.B)}else{this.B=0}})).then((t=>{if(t){this.S.concat(t)}var i=[];for(var e=0;e<this.p;e++){i.push(this.S.readItf8())}this.landmarks=i;this.crc32=this.S.readUint32();return this.S.tell()}))}}class CramDataContainer extends CramContainer{constructor(t,i){super(t,i);this.F=undefined;this.m=this.A()}loadCompressionHeaderBlock(){if(this.F){return this.F}this.F=this.m.then((t=>{this.C=this.landmarks[0]+t-this.g-this.B})).then((()=>this.l.load(this.I+this.g+this.B,this.C))).then((t=>{this.S.concat(t);return this.M()}));return this.F}async M(){var t=await this.m;var i=this.S.readBlock(t);var e=new Map;const s=i.get("IO");{e.set("pm",new Map);e.get("pm").set("RN",true);e.get("pm").set("AP",true);e.get("pm").set("RR",true);const t=s.readItf8();const i=s.readItf8();for(var r=0;r<i;r++){const t=String.fromCharCode.apply("",new Uint8Array(s.read(2)));var n;if(t=="RN"||t=="AP"||t=="RR"){n=s.readBoolean()}else if(t=="SM"){n=s.read(5)}else if(t=="TD"){n=this.decodeTagDictionary(s.readArrayByte())}else{continue}e.get("pm").set(t,n)}}{e.set("dse",new Map);const t=s.readItf8();const i=s.readItf8();for(var r=0;r<i;r++){const t=String.fromCharCode.apply("",new Uint8Array(s.read(2)));var n;if(["BF","CF","RI","RL","AP","RG","MF","NS","NP","TS","NF","TL","FN","FP","DL","RS","PD","HC","MQ"].includes(t)){n=s.readEncodingInt()}else if(["RN","BB","QQ","IN","SC"].includes(t)){n=s.readEncodingByteArray()}else if(["FC","BS","BA","QS"].includes(t)){n=s.readEncodingByte()}else{continue}e.get("dse").set(t,n)}}{e.set("tv",new Map);const t=s.readItf8();const i=s.readItf8();for(var r=0;r<i;r++){const t=s.readItf8();const i=String.fromCharCode((t&16711680)>>16,(t&65280)>>8,t&255);const r=s.readEncodingByteArray();e.get("tv").set(i,r)}}i.set("content",e);return i}decodeTagDictionary(t){var i=new Int8Array(t);var e=[];var s=0;while(s+2<t.byteLength){var r=[];while(i[s]!="\0".charCodeAt(0)){var n=String.fromCharCode(i[s],i[s+1]);var a=String.fromCharCode(i[s+2]);r.push(n+a);s+=3}e.push(r);s+=1}return e}}class CramHeader extends CramContainer{constructor(t){super(t,26);this.fileid=undefined;this.chr_list=undefined;this.N=26;this.R=23;this.g=this.N+this.R;this.m=this.A()}loadChrList(){if(typeof this.chr_list!=="undefined"){return this.chr_list}this.chr_list=this.m.then((t=>{var i=this.S.readBlock(this.I+t);var e=i.get("IO").readString(i.get("rawSize"));var s=[];e.split("\n").forEach((t=>{var i=t.split(RegExp(/\t|:/));if(i[0]=="@SQ"){s.push(i[i.indexOf("SN")+1])}}));return s}));return this.chr_list}A(){var t=this.l.load(0,this.g).then((t=>{this.S=new CramStream(t);var i=this.S.readString(4);var e=new Uint8Array(this.S.read(2));if(i!=="CRAM"||e[0]!==3||e[1]!==0){throw"[invalid file signature] This file is not CRAM 3.0 file."}this.fileid=this.S.readString(20);this.length=this.S.readInt32();this.ref_id=this.S.readItf8();this.starting_ref_pos=this.S.readItf8();this.alignment_span=this.S.readItf8();this.number_records=this.S.readItf8();this.record_counter=this.S.readLtf8();this.bases=this.S.readLtf8();this.number_blocks=this.S.readItf8();this.landmarks=this.S.readArrayItf8();this.crc32=this.S.readUint32();var s=this.S.tell()-this.N;return s}));var i=t.then((t=>{this.B=t+this.landmarks[1]-this.R;return this.l.load(this.g,this.B)}));return Promise.all([t,i]).then((t=>{this.S.concat(t[1]);return t[0]}))}}class CramRans{constructor(t){this.D=new CramStream(t)}ransDecode(){const t=this.D.readInt8();const i=this.D.readUint32();const e=this.D.readUint32();var s=new Uint8Array(e);if(t==0){this.k(s,e)}else{this._(s,e)}return s.buffer}P(t,i){var e=this.D.readUint8();var s=e;var r=0;while(true){var n=this.D.readItf8();t[e]=n;if(r>0){r-=1;e=e+1}else{e=this.D.readUint8();if(e==s+1){r=this.D.readUint8()}}s=e;if(e==0||e==256){break}}i[0]=0;for(var a=0;a<255;a++){i[a+1]=i[a]+t[a]}}U(t){return t&4095}H(t,i){var e=0;while(e+1<t.length&&i>=t[e+1]){e+=1}return e}O(t,i,e){return e*(t>>12)+(t&4095)-i}T(t){while(t<1<<23){t=(t<<8)+this.D.readUint8()}return t}k(t,i){var e=new Array(256).fill(0);var s=new Array(256).fill(0);var r=new Array(4).fill(0);this.P(e,s);for(var n=0;n<4;n++){r[n]=this.D.readUint32()}var a=0;while(a<i){for(var n=0;n<4;n++){if(a+n>=i){return}var h=this.U(r[n]);var o=this.H(s,h);t[a+n]=o;r[n]=this.O(r[n],s[o],e[o]);r[n]=this.T(r[n])}a+=4}}L(t,i){var e=this.D.readUint8();var s=e;var r=0;while(true){this.P(t[e],i[e]);if(r>0){r=r-1;e=e+1}else{e=this.D.readUint8();if(e==s+1){r=this.D.readUint8()}}s=e;if(e==0||e==256){break}}}_(t,i){var e=Array.from(new Array(256),(()=>new Array(256).fill(0)));var s=Array.from(new Array(256),(()=>new Array(256).fill(0)));var r=new Array(4).fill(0);var n=new Array(4).fill(0);this.L(e,s);for(var a=0;a<4;a++){r[a]=this.D.readUint32();n[a]=0}var h=0;while(h<i/4){for(var a=0;a<4;a++){var o=this.U(r[a]);var c=this.H(s[n[a]],o);t[h+Math.floor(a*i/4)]=c;r[a]=this.O(r[a],s[n[a]][c],e[n[a]][c]);r[a]=this.T(r[a]);n[a]=c}h+=1}h*=4;while(h<i){o=this.U(r[3]);c=this.H(s[n[3]],o);t[h+Math.floor(3*i/4)]=c;r[3]=this.O(r[3],s[n[3]][c],e[n[3]][c]);r[3]=this.T(r[3]);n[3]=c;h+=1}return t}}class CramRecord{constructor(t,i){this.bf_=t;this.cf_=i;this.features_=new Array}getBf(){return this.bf_}getCf(){return this.cf_}setBf(t){this.bf_=t}pushFeature(t){this.features_.push(t)}toSAMString(){var t=new String;t+=this.readName===undefined?"":this.readName;t+="\t"+(this.bf_===undefined?"":this.bf_);t+="\t"+(this.refSeqName===undefined?"":this.refSeqName);t+="\t"+(this.position===undefined?"":this.position);t+="\t"+(this.mappingQuality===undefined?"":this.mappingQuality);t+="\t"+(this.cigar===undefined?"":this.cigar);t+="\t"+(this.mateReadName===undefined?"":this.mateReadName);t+="\t"+(this.matePos===undefined?"":this.matePos);t+="\t"+(this.templateSize===undefined?"":this.templateSize);t+="\t"+(this.seq===undefined?"":this.seq)+"\t";t+="\t"+(this.qualityScore===undefined?"":this.qualityScore);t+="\t"+(this.tags===undefined?"":JSON.stringify(this.tags));return t}hasSoftclip(){this.features_.forEach((t=>{if(t.get("FC")=="S"){return true}}));return false}restoreCigar(){this.q();if("cigar"in this||!("readLength"in this)){return}else if(this.features_.length==0){this.cigar=String(this.readLength)+"M";return}else{var t="";var i=[];var e=[""];var s="";var r=0;var n=1;this.features_.forEach((t=>{var a=t.get("FP")-(n+r);if(a>0){if(s=="M"){i[i.length-1]+=a}else{i.push(a);e.push("M");s="M"}}n=t.get("FP");switch(t.get("FC")){case"X":r=1;s="M";if(s=="M"){i[i.length-1]++}else{i.push(1);e.push("M")}break;case"S":r=t.get("SC").length;s="S";i.push(r);e.push("S");break;case"i":r=1;s="I";i.push(1);e.push("I");break;case"I":r=t.get("IN").length;s="I";i.push(t.get("IN").length);e.push("I");break;case"D":r=0;s=t.get("FC");i.push(t.get("DL"));e.push(t.get("FC"));break;case"N":r=0;s=t.get("FC");i.push(t.get("RS"));e.push(t.get("FC"));break;case"P":r=0;s=t.get("FC");i.push(t.get("PD"));e.push(t.get("FC"));break;case"H":r=0;s=t.get("FC");i.push(t.get("HC"));e.push(t.get("FC"));break}}));if(n+r-1<this.readLength){if(s=="M"){i[i.length-1]+=this.readLength-(n+r-1)}else{i.push(this.readLength-(n+r-1));e.push("M")}}for(var a=0;a<i.length;a++){t+=String(i[a])+e[a+1]}this.cigar=t;return}}q(){this.features_.sort(((t,i)=>t.get("FP")-i.get("FP")))}restoreSequence(t){this.q();var i=this.readLength;var e=[];var s=0;var r=this.position;var n=0;for(var a=0;a<this.features_.length+1;a++){var h="";var o=this.readLength;if(a<this.features_.length){h=this.features_[a].get("FC");o=this.features_[a].get("FP")}n+=o-s;s=o;if(h=="I"){i-=this.features_[a].get("IN").length;continue}if(h=="i"){i--;continue}if(h=="S"){i-=this.features_[a].get("SC").length;continue}if(h=="D"||h=="N"||a==this.features_.length){e.push(t.loadSequence(this.refSeqName,r,r+n-1));if(h=="D"){n+=this.features_[a].get("DL")}if(h=="N"){n+=this.features_[a].get("RS")}r=r+n;n=0}}return Promise.all(e).then((t=>{var i="";t.forEach((t=>{i=i.concat(t)}));this.features_.forEach((t=>{var e=t.get("FP");switch(t.get("FC")){case"I":var s=i.slice(0,e-1);var r=i.slice(e-1);var n=String.fromCharCode.apply("",new Uint8Array(t.get("IN")));i=s+n+r;break;case"i":var s=i.slice(0,e-1);var r=i.slice(e-1);var n=String.fromCharCode.apply("",new Uint8Array(t.get("BA")));i=s+n+r;break;case"S":var s=i.slice(0,e-1);var r=i.slice(e-1);var n=String.fromCharCode.apply("",new Uint8Array(t.get("SC")));i=s+n+r;break;case"X":var a=i.slice(e-1,e).toUpperCase();var h="ACGTN".indexOf(a);var o=new Uint8Array(t.get("SM"));var c=o.slice(h,h+1)[0];var d="ACGTN".replace(a,"");var f=new Uint8Array(t.get("BS"))[0];var u="x";for(var v=0;v<4;v++){if((c>>2*(3-v)&3)==f){u=d.charAt(v)}}var s=i.slice(0,e-1);var r=i.slice(e);i=s+u+r;break;default:break}}));this.seq=i.toUpperCase();return this.seq}))}}class CramSlice{constructor(t,i){this.V=t;this.S=new CramStream(i);this.G=undefined;this.X=[]}async loadRecords(){this.Z();this.J();this.X[0].set("IO",new BitsIO(this.X[0].get("IO").arrayBuffer()));const t=this.G.get("content").get("numberOfRecords");var i=[];for(var e=0;e<t;e++){var s=await this.j("BF","Int");var r=await this.j("CF","Int");var n=new CramRecord(s,r);await this.K(n);await this.W(n);await this.Y(n);await this.$(n);if((n.getBf()&4)==0){await this.tt(n)}else{await this.it(n)}i.push(n)}this.et(i);return i}Z(){var t=this.S.readBlock(0);var i=t.get("IO");t.set("content",new Map);t.get("content").set("refSeqId",i.readItf8());t.get("content").set("alignmentStart",i.readItf8());t.get("content").set("alignmentSpan",i.readItf8());t.get("content").set("numberOfRecords",i.readItf8());t.get("content").set("recordCounter",i.readItf8());t.get("content").set("numberOfBlocks",i.readItf8());t.get("content").set("blockContentIds",i.readArrayItf8());t.get("content").set("embeddedRefBasesBlockContentId",i.readItf8());t.get("content").set("refMD5",i.read(16));this.G=t;return t}J(){const t=1+this.G.get("content").get("blockContentIds").length;var i=[];this.S.seek(this.G.get("blockSize"));for(var e=0;e<t;e++){var s=this.S.readBlock();i.push(s)}this.X=i;return i}async j(t,i){var e=await this.V.loadCompressionHeaderBlock();var s=e.get("content").get("dse").get(t);return this.st(s,i)}st(t,i){var e=t.get("codecId");if(e==1){var s=this.rt(t.get("externalId")).get("IO");if(i=="Int"){return s.readItf8()}else if(i=="Byte"){return s.read(1)}else{throw"type "+i+" is not supported. (codecId: 1)"}}else if(e==3){const i=t.get("alphabet");const e=t.get("bit-length");if(e.length==1&&e[0]==0){return i[0]}else{throw"HUFFMAN decoding is in the process of being implemented."}}else if(e==5){var s=this.rt(t.get("externalId")).get("IO");var r=[];var n=new CramStream(t.get("stopByte"));const i=n.readUint8();while(true){var a=s.readUint8();if(a==i){return r}r.push(a)}}else if(e==6){return this.X[0].get("IO").read(t.get("length"))-t.get("offset")}else{throw"codecId: "+str(e)+" is not supported."}}rt(t){var i=this.G.get("content").get("blockContentIds").indexOf(t);return this.X[i+1]}async K(t){if(this.G.get("content").get("refSeqId")==-2){t.refSeqId=await this.j("RI","Int")}else{t.refSeqId=this.G.get("content").get("refSeqid")}t.readLength=await this.j("RL","Int");var i=await this.V.loadCompressionHeaderBlock();if(i.get("content").get("pm").get("AP")!=0){if(typeof this.nt=="undefined"){this.nt=this.G.get("content").get("alignmentStart")}var e=await this.j("AP","Int");t.position=e+this.nt;this.nt=t.position}else{var e=await this.j("AP","Int");t.position=e}t.readGroup=await this.j("RG","Int")}async W(t){var i=await this.V.loadCompressionHeaderBlock();if(i.get("content").get("pm").get("RN")){var e=await this.j("RN","ByteArray");var s="";e.forEach((t=>{s+=String.fromCharCode(t)}));t.readName=s}else{t.readName=this.at(t)}}at(t){generatedName="generatedName"+String(t.refSeqId)+"."+String(t.position);return generatedName}async Y(t){if((t.getCf()&2)==2){const e=await this.j("MF","Int");if((e&1)==1){t.setBf(t.getBf()|32)}if((e&2)==2){t.setBf(t.getBf()|8)}var i=await this.V.loadCompressionHeaderBlock();if(!i.get("content").get("pm").get("RN")){rn=await this.j("RN","ByteArray");t.readName=String(rn)}t.mateRefId=await this.j("NS","Int");t.matePos=await this.j("NP","Int");t.templateSize=await this.j("TS","Int")}else if((t.getCf()&4)==4){t.nextFrag=await this.j("NF","Int")}}async $(t){const i=await this.j("TL","Int");var e=await this.V.loadCompressionHeaderBlock();var s={};const r=t=>{var i=t.slice(0,2);const r=t.slice(-1);var n=e.get("content").get("tv").get(t).get("valuesEncoding");var a;if(r=="A"){a=this.st(n,"Char")}else if(r=="c"||r=="C"||r=="s"||r=="S"||r=="i"||r=="I"){a=this.st(n,"Int")}else if(r=="f"){a=this.st(n,"float32")}else if(r=="Z"){a=this.st(n,"String")}else if(r=="H"){a=this.st(n,"Hstring")}else if(r=="B"){a=this.st(n,"ByteArray")}else{console.error("tagType'"+String(r)+"' is not supported.");return}s[t]=a};for(var n of e.get("content").get("pm").get("TD")[i])r(n);t.tags=s}async tt(t){const i=await this.j("FN","Int");for(var e=0;e<i;e++){await this.ht(t)}t.mappingQuality=await this.j("MQ","Int");var s=await this.V.loadCompressionHeaderBlock();if(s.get("content").get("dse").has("QS")){t.qualityScore=await this.ot(t.readLength)}}async ht(t){var i=new Map;var e=await this.j("FC","Byte");i.set("FC",String.fromCharCode.apply("",new Uint8Array(e)));i.set("FP",await this.j("FP","Int"));if(i.get("FC")=="B"){i.set("BA",await this.j("BA","Byte"));i.set("QS",await this.j("QS","Byte"))}else if(i.get("FC")=="X"){i.set("BS",await this.j("BS","Byte"));var s=await this.V.loadCompressionHeaderBlock();i.set("SM",s.get("content").get("pm").get("SM"))}else if(i.get("FC")=="I"){i.set("IN",await this.j("IN","ByteArray"))}else if(i.get("FC")=="S"){i.set("SC",await this.j("SC","ByteArray"))}else if(i.get("FC")=="H"){i.set("HC",await this.j("HC","Int"))}else if(i.get("FC")=="P"){i.set("PD",await this.j("PD","Int"))}else if(i.get("FC")=="D"){i.set("DL",await this.j("DL","Int"))}else if(i.get("FC")=="N"){i.set("RS",await this.j("RS","Int"))}else if(i.get("FC")=="i"){i.set("BA",await this.j("BA","Byte"))}else if(i.get("FC")=="b"){i.set("BB",await this.j("BB","ByteArray"))}else if(i.get("FC")=="q"){i.set("QQ",await this.j("QQ","ByteArray"))}else if(i.get("FC")=="Q"){i.set("QS",await this.j("QS","Byte"))}t.pushFeature(i)}async it(t){b=new Array(t.readLength);for(var i=0;i<t.readLength;i++){b[i]=await this.j("BA","Byte")}t.base=b;var e=await this.V.loadCompressionHeaderBlock();if(e.get("content").get("dse").has("QS")){t.qualityScore=await this.ot(t.readLength)}}async ot(t){var i=new Array(t);for(var e=0;e<t;e++){var s=await this.j("QS","Int");i[e]=s+33}return String.fromCharCode.apply("",i)}et(t){for(var i=0;i<t.length;i++){var e=t[i];if((e.getCf()&4)==4){var s=t[i+e.nextFrag+1];if((s.getBf()&16)==16){e.setBf(e.getBf()|32)}if((s.getBf()&4)==4){e.setBf(e.getBf()|8)}e.mateReadName=s.readName;s.mateReadName=e.readName;e.mateRefId=s.refSeqId;s.mateRefId=e.refSeqId;e.matePos=s.position;s.matePos=e.position;if(e.refSeqId!=s.refSeqId){e.templateSize=0;s.templateSize=0;return}var r=e.readLength-(e.hasSoftclip()?e.features.get("S").length:0);var n=s.readLength-(s.hasSoftclip()?s.features.get("S").length:0);var a=[e.position,e.position+((e.getBf()&16)!=16?r-1:-r+1),s.position,s.position-((s.getBf()&16)!=16?n-1:-n+1)];var h=Math.min(...a);var o=Math.max(...a);var c=a.indexOf(h)<2?e:s;var d=a.indexOf(o)<2?e:s;c.templateSize=o-h+1;d.templateSize=-(o-h+1)}}}}class CramStream{constructor(t){if(!t){throw"[CramStream] Invalid argument: arrbuf is undefined (falsy)"}this.ct=t;this.dt=0}arrayBuffer(){return this.ct}concat(t){var i=new Uint8Array(this.ct.byteLength+t.byteLength);i.set(new Uint8Array(this.ct),0);i.set(new Uint8Array(t),this.ct.byteLength);this.ct=i.buffer}tell(){return this.dt}seek(t){this.dt=t}read(t){const i=this.ct.slice(this.dt,this.dt+t);this.dt+=t;return i}readInt8(){const t=new DataView(this.read(1));return t.getInt8(0)}readInt16(){const t=new DataView(this.read(2));return t.getInt16(0,true)}readInt32(){const t=new DataView(this.read(4));return t.getInt32(0,true)}readInt64(){const t=new DataView(this.read(8));return t.getBigInt64(0,true)}readUint8(){const t=new DataView(this.read(1));if(t.byteLength<1){return 0}return t.getUint8(0)}readUint16(){const t=new DataView(this.read(2));return t.getUint16(0,true)}readUint32(){const t=new DataView(this.read(4));return t.getUint32(0,true)}readUint64(){const t=new DataView(this.read(8));return t.getBigUint64(0,true)}readBoolean(){const t=new DataView(this.read(1));const i=t.getInt8(0,true);return i==1}readChar(){return String.fromCharCode.apply("",new Uint8Array(this.read(1)))}readString(t){return String.fromCharCode.apply("",new Uint8Array(this.read(t)))}readItf8(){const t=this.readUint8();if(t>>7==0){return t&127}else if(t>>6==2){const i=this.readUint8();return(t&63)<<8|i}else if(t>>5==6){const i=this.readUint8();const e=this.readUint8();return(t&31)<<16|i<<8|e}else if(t>>4==14){const i=this.readUint8();const e=this.readUint8();const s=this.readUint8();return(t&15)<<24|i<<16|e<<8|s}else{const i=this.readUint8();const e=this.readUint8();const s=this.readUint8();const r=this.readUint8();const n=(t&15)<<28|i<<20|e<<12|s<<4|r&15;if(n<2**31){return n}else{return n-2**32}}}readLtf8(){const t=BigInt(this.readUint8());if(t>>7n==0b0n){return t&0b01111111n}else if(t>>6n==0b10n){const i=BigInt(this.readInt8());return(t&0b00111111n)<<8n|i}else if(t>>5n==0b110n){const i=BigInt(this.readUint8());const e=BigInt(this.readUint8());return(t&0b00011111n)<<16n|i<<8n|e}else if(t>>4n==0b1110n){const i=BigInt(this.readUint8());const e=BigInt(this.readUint8());const s=BigInt(this.readUint8());return(t&0b00001111n)<<24n|i<<16n|e<<8n|s}else if(t>>3n==0b11110n){const i=BigInt(this.readUint8());const e=BigInt(this.readUint8());const s=BigInt(this.readUint8());const r=BigInt(this.readUint8());return(t&0b00000111n)<<32n|i<<24n|e<<16n|s<<8n|r}else if(t>>2n==0b111110n){const i=BigInt(this.readUint8());const e=BigInt(this.readUint8());const s=BigInt(this.readUint8());const r=BigInt(this.readUint8());const n=BigInt(this.readUint8());return(t&0b00000011n)<<40n|i<<32n|e<<24n|s<<16n|r<<8n|n}else if(t>>1n==0b1111110n){const i=BigInt(this.readUint8());const e=BigInt(this.readUint8());const s=BigInt(this.readUint8());const r=BigInt(this.readUint8());const n=BigInt(this.readUint8());const a=BigInt(this.readUint8());return(t&0b00000001n)<<48n|i<<40n|e<<32n|s<<24n|r<<16n|n<<8n|a}else if(t==0b11111110n){const t=BigInt(this.readUint8());const i=BigInt(this.readUint8());const e=BigInt(this.readUint8());const s=BigInt(this.readUint8());const r=BigInt(this.readUint8());const n=BigInt(this.readUint8());const a=BigInt(this.readUint8());return t<<48n|i<<40n|e<<32n|s<<24n|r<<16n|n<<8n|a}else{return this.readInt64()}}readArrayItf8(){var t=[];const i=this.readItf8();for(var e=0;e<i;e++){t.push(this.readItf8())}return t}readArrayByte(){const t=this.readItf8();return this.read(t)}readEncodingInt(){var t=new Map;t.set("codecId",this.readItf8());const i=this.readItf8();if(t.get("codecId")==1){t.set("externalId",this.readItf8());return t}else if(t.get("codecId")==3){t.set("alphabet",this.readArrayItf8());t.set("bit-length",this.readArrayItf8());return t}else if(t.get("codecId")==6){t.set("offset",this.readItf8());t.set("length",this.readItf8());return t}else if(t.get("codecId")==7){t.set("offset",this.readItf8());t.set("k",readItf8());return t}else if(t.get("codecId")==9){t.set("offset",readItf8());return t}else{console.log("Error: invalid codec ID");return t}}readEncodingByte(){var t=new Map;t.set("codecId",this.readItf8());const i=this.readItf8();if(t.get("codecId")==1){t.set("externalId",this.readItf8());return t}else if(t.get("codecId")==3){t.set("alphabet",this.readArrayItf8());t.set("bit-length",this.readArrayItf8());return t}else{console.log("Error: invalid codec ID");return t}}readEncodingByteArray(){var t=new Map;t.set("codecId",this.readItf8());const i=this.readItf8();if(t.get("codecId")==4){t.set("lengthsEncoding",this.readEncodingInt());t.set("valuesEncoding",this.readEncodingByte());return t}else if(t.get("codecId")==5){t.set("stopByte",this.read(1));t.set("externalId",this.readItf8());return t}else{console.log("Error: invalid codec ID");return t}}readBlock(t=-1){var i=new Map;if(t>=0){this.seek(t)}const e=this.tell();i.set("method",this.readInt8());i.set("contentTypeId",this.readInt8());i.set("contentId",this.readItf8());i.set("size",this.readItf8());i.set("rawSize",this.readItf8());const s=this.read(i.get("size"));var r;if(i.get("method")==0){r=s}else if(i.get("method")==1){var n=new Uint8Array(s);var a=new Zlib.Gunzip(n);var h=a.decompress();r=h.buffer}else if(i.get("method")==2){throw"bzip2 is not supported"}else if(i.get("method")==3){throw"lzma is not supported"}else if(i.get("method")==4){var o=new CramRans(s);r=o.ransDecode()}else{throw"unknown compression method"}i.set("IO",new CramStream(r));i.set("CRC32",this.readUint32());i.set("blockSize",this.tell()-e);return i}}onmessage=function(t){var i=t[0].getRecords(t[1],t[2],t[3]).then((t=>{var i=new String;t.forEach((t=>{console.log(t);i+=t.toSAMString()+"\n"}));changeState(i);console.log(i);console.log("finished.")})).catch((t=>{console.log(t);changeState("Error occurred. ("+t+")")}));postMessage(i)};
