class BitsIO{constructor(t){this.t=new Uint8Array(t);this.i=0;this.h=0;this.o=0;this.u()}read(t){var i=0;var e=t;while(e>0){i+=this.v()*2**(e-1);e-=1}return i}v(){const t=(this.h&2**this.o)>>this.o;if(this.o==0){this.u()}else{this.o-=1}return t}u(){this.h=this.t[this.i];this.i+=1;this.o=7}}class CramContainer{constructor(t,i){this.l=t;this.I=i;this.g=undefined;this.S=4+5*4+9*2+5*2;this.B=undefined;this.C=undefined;this.m=undefined}getPosition(){return this.I}loadHeaderLength(){if(typeof this.m==="undefined"){this.m=this.p()}return this.m}p(){return this.l.load(this.I,this.S).then((t=>{this.g=new CramStream(t);this.length=this.g.readInt32();this.ref_id=this.g.readItf8();this.starting_ref_pos=this.g.readItf8();this.alignment_span=this.g.readItf8();this.number_records=this.g.readItf8();this.record_counter=this.g.readLtf8();this.bases=this.g.readLtf8();this.number_blocks=this.g.readItf8();this.A=this.g.readItf8();var i=this.S-this.g.tell();this.B=5*this.A+4-i;if(this.B>0){return this.l.load(this.I+this.S,this.B)}else{this.B=0}})).then((t=>{if(t){this.g.concat(t)}var i=[];for(var e=0;e<this.A;e++){i.push(this.g.readItf8())}this.landmarks=i;this.crc32=this.g.readUint32();return this.g.tell()}))}}class CramDataContainer extends CramContainer{constructor(t,i){super(t,i);this.F=undefined;this.m=undefined}loadCompressionHeaderBlock(){if(this.F){return this.F}if(typeof this.m==="undefined"){this.m=this.p()}this.F=this.m.then((t=>{this.C=this.landmarks[0]+t-this.S-this.B})).then((()=>this.l.load(this.I+this.S+this.B,this.C))).then((t=>{this.g.concat(t);return this.M()}));return this.F}async M(){var t=await this.m;var i=this.g.readBlock(t);var e=new Map;const s=i.get("IO");{e.set("pm",new Map);e.get("pm").set("RN",true);e.get("pm").set("AP",true);e.get("pm").set("RR",true);const t=s.readItf8();const i=s.readItf8();for(var r=0;r<i;r++){const t=String.fromCharCode.apply("",new Uint8Array(s.read(2)));var n;if(t=="RN"||t=="AP"||t=="RR"){n=s.readBoolean()}else if(t=="SM"){n=s.read(5)}else if(t=="TD"){n=this.decodeTagDictionary(s.readArrayByte())}else{continue}e.get("pm").set(t,n)}}{e.set("dse",new Map);const t=s.readItf8();const i=s.readItf8();for(var r=0;r<i;r++){const t=String.fromCharCode.apply("",new Uint8Array(s.read(2)));var n;if(["BF","CF","RI","RL","AP","RG","MF","NS","NP","TS","NF","TL","FN","FP","DL","RS","PD","HC","MQ"].includes(t)){n=s.readEncodingInt()}else if(["RN","BB","QQ","IN","SC"].includes(t)){n=s.readEncodingByteArray()}else if(["FC","BS","BA","QS"].includes(t)){n=s.readEncodingByte()}else{continue}e.get("dse").set(t,n)}}{e.set("tv",new Map);const t=s.readItf8();const i=s.readItf8();for(var r=0;r<i;r++){const t=s.readItf8();const i=String.fromCharCode((t&16711680)>>16,(t&65280)>>8,t&255);const r=s.readEncodingByteArray();e.get("tv").set(i,r)}}i.set("content",e);return i}decodeTagDictionary(t){var i=new Int8Array(t);var e=[];var s=0;while(s+2<t.byteLength){var r=[];while(i[s]!="\0".charCodeAt(0)){var n=String.fromCharCode(i[s],i[s+1]);var a=String.fromCharCode(i[s+2]);r.push(n+a);s+=3}e.push(r);s+=1}return e}}class CramHeader extends CramContainer{constructor(t){super(t,26);this.fileid=undefined;this.chr_list=undefined;this.N=26;this.R=23;this.S=this.N+this.R;this.m=undefined}loadChrList(){if(typeof this.chr_list!=="undefined"){return this.chr_list}if(typeof this.m==="undefined"){this.m=this.p()}this.chr_list=this.m.then((t=>{var i=this.g.readBlock(this.I+t);var e=i.get("IO").readString(i.get("rawSize"));var s=[];e.split("\n").forEach((t=>{var i=t.split(RegExp(/\t|:/));if(i[0]=="@SQ"){s.push(i[i.indexOf("SN")+1])}}));return s}));return this.chr_list}p(){var t=this.l.load(0,this.S).then((t=>{this.g=new CramStream(t);var i=this.g.readString(4);var e=new Uint8Array(this.g.read(2));if(i!=="CRAM"||e[0]!==3||e[1]!==0){throw"[invalid file signature] This file is not CRAM 3.0 file."}this.fileid=this.g.readString(20);this.length=this.g.readInt32();this.ref_id=this.g.readItf8();this.starting_ref_pos=this.g.readItf8();this.alignment_span=this.g.readItf8();this.number_records=this.g.readItf8();this.record_counter=this.g.readLtf8();this.bases=this.g.readLtf8();this.number_blocks=this.g.readItf8();this.landmarks=this.g.readArrayItf8();this.crc32=this.g.readUint32();var s=this.g.tell()-this.N;return s}));var i=t.then((t=>{this.B=t+this.landmarks[1]-this.R;return this.l.load(this.S,this.B)}));return Promise.all([t,i]).then((t=>{this.g.concat(t[1]);return t[0]}))}}class CramRans{constructor(t){this.D=new CramStream(t)}ransDecode(){const t=this.D.readInt8();const i=this.D.readUint32();const e=this.D.readUint32();var s=new Uint8Array(e);if(t==0){this.k(s,e)}else{this._(s,e)}return s.buffer}P(t,i){var e=this.D.readUint8();var s=e;var r=0;while(true){var n=this.D.readItf8();t[e]=n;if(r>0){r-=1;e=e+1}else{e=this.D.readUint8();if(e==s+1){r=this.D.readUint8()}}s=e;if(e==0||e==256){break}}i[0]=0;for(var a=0;a<255;a++){i[a+1]=i[a]+t[a]}}U(t){return t&4095}H(t,i){var e=0;while(e+1<t.length&&i>=t[e+1]){e+=1}return e}O(t,i,e){return e*(t>>12)+(t&4095)-i}T(t){while(t<1<<23){t=(t<<8)+this.D.readUint8()}return t}k(t,i){var e=new Array(256).fill(0);var s=new Array(256).fill(0);var r=new Array(4).fill(0);this.P(e,s);for(var n=0;n<4;n++){r[n]=this.D.readUint32()}var a=0;while(a<i){for(var n=0;n<4;n++){if(a+n>=i){return}var h=this.U(r[n]);var o=this.H(s,h);t[a+n]=o;r[n]=this.O(r[n],s[o],e[o]);r[n]=this.T(r[n])}a+=4}}L(t,i){var e=this.D.readUint8();var s=e;var r=0;while(true){this.P(t[e],i[e]);if(r>0){r=r-1;e=e+1}else{e=this.D.readUint8();if(e==s+1){r=this.D.readUint8()}}s=e;if(e==0||e==256){break}}}_(t,i){var e=Array.from(new Array(256),(()=>new Array(256).fill(0)));var s=Array.from(new Array(256),(()=>new Array(256).fill(0)));var r=new Array(4).fill(0);var n=new Array(4).fill(0);this.L(e,s);for(var a=0;a<4;a++){r[a]=this.D.readUint32();n[a]=0}var h=0;while(h<i/4){for(var a=0;a<4;a++){var o=this.U(r[a]);var c=this.H(s[n[a]],o);t[h+Math.floor(a*i/4)]=c;r[a]=this.O(r[a],s[n[a]][c],e[n[a]][c]);r[a]=this.T(r[a]);n[a]=c}h+=1}h*=4;while(h<i){o=this.U(r[3]);c=this.H(s[n[3]],o);t[h+Math.floor(3*i/4)]=c;r[3]=this.O(r[3],s[n[3]][c],e[n[3]][c]);r[3]=this.T(r[3]);n[3]=c;h+=1}return t}}class CramRecord{constructor(t,i){this.bf_=t;this.cf_=i;this.features_=new Array}getBf(){return this.bf_}getCf(){return this.cf_}setBf(t){this.bf_=t}pushFeature(t){this.features_.push(t)}toSAMString(){var t=new String;t+=this.readName===undefined?"":this.readName;t+="\t"+(this.bf_===undefined?"":this.bf_);t+="\t"+(this.refSeqName===undefined?"":this.refSeqName);t+="\t"+(this.position===undefined?"":this.position);t+="\t"+(this.mappingQuality===undefined?"":this.mappingQuality);t+="\t"+(this.cigar===undefined?"":this.cigar);t+="\t"+(this.mateReadName===undefined?"":this.mateReadName);t+="\t"+(this.matePos===undefined?"":this.matePos);t+="\t"+(this.templateSize===undefined?"":this.templateSize);t+="\t"+(this.seq===undefined?"":this.seq)+"\t";t+="\t"+(this.qualityScore===undefined?"":this.qualityScore);t+="\t"+(this.tags===undefined?"":JSON.stringify(this.tags));return t}hasSoftclip(){this.features_.forEach((t=>{if(t.get("FC")=="S"){return true}}));return false}restoreCigar(){this.q();if("cigar"in this||!("readLength"in this)){return}else if(this.features_.length==0){this.cigar=String(this.readLength)+"M";return}else{var t="";var i=[];var e=[""];var s="";var r=0;var n=1;this.features_.forEach((t=>{var a=t.get("FP")-(n+r);if(a>0){if(s=="M"){i[i.length-1]+=a}else{i.push(a);e.push("M");s="M"}}n=t.get("FP");switch(t.get("FC")){case"X":r=1;s="M";if(s=="M"){i[i.length-1]++}else{i.push(1);e.push("M")}break;case"S":r=t.get("SC").length;s="S";i.push(r);e.push("S");break;case"i":r=1;s="I";i.push(1);e.push("I");break;case"I":r=t.get("IN").length;s="I";i.push(t.get("IN").length);e.push("I");break;case"D":r=0;s=t.get("FC");i.push(t.get("DL"));e.push(t.get("FC"));break;case"N":r=0;s=t.get("FC");i.push(t.get("RS"));e.push(t.get("FC"));break;case"P":r=0;s=t.get("FC");i.push(t.get("PD"));e.push(t.get("FC"));break;case"H":r=0;s=t.get("FC");i.push(t.get("HC"));e.push(t.get("FC"));break}}));if(n+r-1<this.readLength){if(s=="M"){i[i.length-1]+=this.readLength-(n+r-1)}else{i.push(this.readLength-(n+r-1));e.push("M")}}for(var a=0;a<i.length;a++){t+=String(i[a])+e[a+1]}this.cigar=t;return}}q(){this.features_.sort(((t,i)=>t.get("FP")-i.get("FP")))}restoreSequence(t){this.q();var i=this.readLength;var e=[];var s=0;var r=this.position;var n=0;for(var a=0;a<this.features_.length+1;a++){var h="";var o=this.readLength;if(a<this.features_.length){h=this.features_[a].get("FC");o=this.features_[a].get("FP")}n+=o-s;s=o;if(h=="I"){i-=this.features_[a].get("IN").length;continue}if(h=="i"){i--;continue}if(h=="S"){i-=this.features_[a].get("SC").length;continue}if(h=="D"||h=="N"||a==this.features_.length){e.push(t.loadSequence(this.refSeqName,r,r+n-1));if(h=="D"){n+=this.features_[a].get("DL")}if(h=="N"){n+=this.features_[a].get("RS")}r=r+n;n=0}}return Promise.all(e).then((t=>{var i="";t.forEach((t=>{i=i.concat(t)}));this.features_.forEach((t=>{var e=t.get("FP");switch(t.get("FC")){case"I":var s=i.slice(0,e-1);var r=i.slice(e-1);var n=String.fromCharCode.apply("",new Uint8Array(t.get("IN")));i=s+n+r;break;case"i":var s=i.slice(0,e-1);var r=i.slice(e-1);var n=String.fromCharCode.apply("",new Uint8Array(t.get("BA")));i=s+n+r;break;case"S":var s=i.slice(0,e-1);var r=i.slice(e-1);var n=String.fromCharCode.apply("",new Uint8Array(t.get("SC")));i=s+n+r;break;case"X":var a=i.slice(e-1,e).toUpperCase();var h="ACGTN".indexOf(a);var o=new Uint8Array(t.get("SM"));var c=o.slice(h,h+1)[0];var d="ACGTN".replace(a,"");var f=new Uint8Array(t.get("BS"))[0];var u="x";for(var v=0;v<4;v++){if((c>>2*(3-v)&3)==f){u=d.charAt(v)}}var s=i.slice(0,e-1);var r=i.slice(e);i=s+u+r;break;default:break}}));this.seq=i.toUpperCase();return this.seq}))}}class CramSlice{constructor(t,i){this.V=t;this.g=new CramStream(i);this.G=undefined;this.X=[]}async loadRecords(){this.Z();this.J();this.X[0].set("IO",new BitsIO(this.X[0].get("IO").arrayBuffer()));const t=this.G.get("content").get("numberOfRecords");var i=[];for(var e=0;e<t;e++){var s=await this.j("BF","Int");var r=await this.j("CF","Int");var n=new CramRecord(s,r);await this.K(n);await this.W(n);await this.Y(n);await this.$(n);if((n.getBf()&4)==0){await this.tt(n)}else{await this.it(n)}i.push(n)}this.et(i);return i}Z(){var t=this.g.readBlock(0);var i=t.get("IO");t.set("content",new Map);t.get("content").set("refSeqId",i.readItf8());t.get("content").set("alignmentStart",i.readItf8());t.get("content").set("alignmentSpan",i.readItf8());t.get("content").set("numberOfRecords",i.readItf8());t.get("content").set("recordCounter",i.readItf8());t.get("content").set("numberOfBlocks",i.readItf8());t.get("content").set("blockContentIds",i.readArrayItf8());t.get("content").set("embeddedRefBasesBlockContentId",i.readItf8());t.get("content").set("refMD5",i.read(16));this.G=t;return t}J(){const t=1+this.G.get("content").get("blockContentIds").length;var i=[];this.g.seek(this.G.get("blockSize"));for(var e=0;e<t;e++){var s=this.g.readBlock();i.push(s)}this.X=i;return i}async j(t,i){var e=await this.V.loadCompressionHeaderBlock();var s=e.get("content").get("dse").get(t);return this.st(s,i)}st(t,i){var e=t.get("codecId");if(e==1){var s=this.rt(t.get("externalId")).get("IO");if(i=="Int"){return s.readItf8()}else if(i=="Byte"){return s.read(1)}else{throw"type "+i+" is not supported. (codecId: 1)"}}else if(e==3){const i=t.get("alphabet");const e=t.get("bit-length");if(e.length==1&&e[0]==0){return i[0]}else{throw"HUFFMAN decoding is in the process of being implemented."}}else if(e==5){var s=this.rt(t.get("externalId")).get("IO");var r=[];var n=new CramStream(t.get("stopByte"));const i=n.readUint8();while(true){var a=s.readUint8();if(a==i){return r}r.push(a)}}else if(e==6){return this.X[0].get("IO").read(t.get("length"))-t.get("offset")}else{throw"codecId: "+str(e)+" is not supported."}}rt(t){var i=this.G.get("content").get("blockContentIds").indexOf(t);return this.X[i+1]}async K(t){if(this.G.get("content").get("refSeqId")==-2){t.refSeqId=await this.j("RI","Int")}else{t.refSeqId=this.G.get("content").get("refSeqid")}t.readLength=await this.j("RL","Int");var i=await this.V.loadCompressionHeaderBlock();if(i.get("content").get("pm").get("AP")!=0){if(typeof this.nt=="undefined"){this.nt=this.G.get("content").get("alignmentStart")}var e=await this.j("AP","Int");t.position=e+this.nt;this.nt=t.position}else{var e=await this.j("AP","Int");t.position=e}t.readGroup=await this.j("RG","Int")}async W(t){var i=await this.V.loadCompressionHeaderBlock();if(i.get("content").get("pm").get("RN")){var e=await this.j("RN","ByteArray");var s="";e.forEach((t=>{s+=String.fromCharCode(t)}));t.readName=s}else{t.readName=this.at(t)}}at(t){generatedName="generatedName"+String(t.refSeqId)+"."+String(t.position);return generatedName}async Y(t){if((t.getCf()&2)==2){const e=await this.j("MF","Int");if((e&1)==1){t.setBf(t.getBf()|32)}if((e&2)==2){t.setBf(t.getBf()|8)}var i=await this.V.loadCompressionHeaderBlock();if(!i.get("content").get("pm").get("RN")){rn=await this.j("RN","ByteArray");t.readName=String(rn)}t.mateRefId=await this.j("NS","Int");t.matePos=await this.j("NP","Int");t.templateSize=await this.j("TS","Int")}else if((t.getCf()&4)==4){t.nextFrag=await this.j("NF","Int")}}async $(t){const i=await this.j("TL","Int");var e=await this.V.loadCompressionHeaderBlock();var s={};const r=t=>{var i=t.slice(0,2);const r=t.slice(-1);var n=e.get("content").get("tv").get(t).get("valuesEncoding");var a;if(r=="A"){a=this.st(n,"Char")}else if(r=="c"||r=="C"||r=="s"||r=="S"||r=="i"||r=="I"){a=this.st(n,"Int")}else if(r=="f"){a=this.st(n,"float32")}else if(r=="Z"){a=this.st(n,"String")}else if(r=="H"){a=this.st(n,"Hstring")}else if(r=="B"){a=this.st(n,"ByteArray")}else{console.error("tagType'"+String(r)+"' is not supported.");return}s[t]=a};for(var n of e.get("content").get("pm").get("TD")[i])r(n);t.tags=s}async tt(t){const i=await this.j("FN","Int");for(var e=0;e<i;e++){await this.ht(t)}t.mappingQuality=await this.j("MQ","Int");var s=await this.V.loadCompressionHeaderBlock();if(s.get("content").get("dse").has("QS")){t.qualityScore=await this.ot(t.readLength)}}async ht(t){var i=new Map;var e=await this.j("FC","Byte");i.set("FC",String.fromCharCode.apply("",new Uint8Array(e)));i.set("FP",await this.j("FP","Int"));if(i.get("FC")=="B"){i.set("BA",await this.j("BA","Byte"));i.set("QS",await this.j("QS","Byte"))}else if(i.get("FC")=="X"){i.set("BS",await this.j("BS","Byte"));var s=await this.V.loadCompressionHeaderBlock();i.set("SM",s.get("content").get("pm").get("SM"))}else if(i.get("FC")=="I"){i.set("IN",await this.j("IN","ByteArray"))}else if(i.get("FC")=="S"){i.set("SC",await this.j("SC","ByteArray"))}else if(i.get("FC")=="H"){i.set("HC",await this.j("HC","Int"))}else if(i.get("FC")=="P"){i.set("PD",await this.j("PD","Int"))}else if(i.get("FC")=="D"){i.set("DL",await this.j("DL","Int"))}else if(i.get("FC")=="N"){i.set("RS",await this.j("RS","Int"))}else if(i.get("FC")=="i"){i.set("BA",await this.j("BA","Byte"))}else if(i.get("FC")=="b"){i.set("BB",await this.j("BB","ByteArray"))}else if(i.get("FC")=="q"){i.set("QQ",await this.j("QQ","ByteArray"))}else if(i.get("FC")=="Q"){i.set("QS",await this.j("QS","Byte"))}t.pushFeature(i)}async it(t){b=new Array(t.readLength);for(var i=0;i<t.readLength;i++){b[i]=await this.j("BA","Byte")}t.base=b;var e=await this.V.loadCompressionHeaderBlock();if(e.get("content").get("dse").has("QS")){t.qualityScore=await this.ot(t.readLength)}}async ot(t){var i=new Array(t);for(var e=0;e<t;e++){var s=await this.j("QS","Int");i[e]=s+33}return String.fromCharCode.apply("",i)}et(t){for(var i=0;i<t.length;i++){var e=t[i];if((e.getCf()&4)==4){var s=t[i+e.nextFrag+1];if((s.getBf()&16)==16){e.setBf(e.getBf()|32)}if((s.getBf()&4)==4){e.setBf(e.getBf()|8)}e.mateReadName=s.readName;s.mateReadName=e.readName;e.mateRefId=s.refSeqId;s.mateRefId=e.refSeqId;e.matePos=s.position;s.matePos=e.position;if(e.refSeqId!=s.refSeqId){e.templateSize=0;s.templateSize=0;return}var r=e.readLength-(e.hasSoftclip()?e.features.get("S").length:0);var n=s.readLength-(s.hasSoftclip()?s.features.get("S").length:0);var a=[e.position,e.position+((e.getBf()&16)!=16?r-1:-r+1),s.position,s.position-((s.getBf()&16)!=16?n-1:-n+1)];var h=Math.min(...a);var o=Math.max(...a);var c=a.indexOf(h)<2?e:s;var d=a.indexOf(o)<2?e:s;c.templateSize=o-h+1;d.templateSize=-(o-h+1)}}}}class CramStream{constructor(t){if(!t){throw"[CramStream] Invalid argument: arrbuf is undefined (falsy)"}this.ct=t;this.dt=0}arrayBuffer(){return this.ct}concat(t){var i=new Uint8Array(this.ct.byteLength+t.byteLength);i.set(new Uint8Array(this.ct),0);i.set(new Uint8Array(t),this.ct.byteLength);this.ct=i.buffer}tell(){return this.dt}seek(t){this.dt=t}read(t){const i=this.ct.slice(this.dt,this.dt+t);this.dt+=t;return i}readInt8(){const t=new DataView(this.read(1));return t.getInt8(0)}readInt16(){const t=new DataView(this.read(2));return t.getInt16(0,true)}readInt32(){const t=new DataView(this.read(4));return t.getInt32(0,true)}readInt64(){const t=new DataView(this.read(8));return t.getBigInt64(0,true)}readUint8(){const t=new DataView(this.read(1));if(t.byteLength<1){return 0}return t.getUint8(0)}readUint16(){const t=new DataView(this.read(2));return t.getUint16(0,true)}readUint32(){const t=new DataView(this.read(4));return t.getUint32(0,true)}readUint64(){const t=new DataView(this.read(8));return t.getBigUint64(0,true)}readBoolean(){const t=new DataView(this.read(1));const i=t.getInt8(0,true);return i==1}readChar(){return String.fromCharCode.apply("",new Uint8Array(this.read(1)))}readString(t){return String.fromCharCode.apply("",new Uint8Array(this.read(t)))}readItf8(){const t=this.readUint8();if(t>>7==0){return t&127}else if(t>>6==2){const i=this.readUint8();return(t&63)<<8|i}else if(t>>5==6){const i=this.readUint8();const e=this.readUint8();return(t&31)<<16|i<<8|e}else if(t>>4==14){const i=this.readUint8();const e=this.readUint8();const s=this.readUint8();return(t&15)<<24|i<<16|e<<8|s}else{const i=this.readUint8();const e=this.readUint8();const s=this.readUint8();const r=this.readUint8();const n=(t&15)<<28|i<<20|e<<12|s<<4|r&15;if(n<2**31){return n}else{return n-2**32}}}readLtf8(){const t=BigInt(this.readUint8());if(t>>7n==0b0n){return t&0b01111111n}else if(t>>6n==0b10n){const i=BigInt(this.readInt8());return(t&0b00111111n)<<8n|i}else if(t>>5n==0b110n){const i=BigInt(this.readUint8());const e=BigInt(this.readUint8());return(t&0b00011111n)<<16n|i<<8n|e}else if(t>>4n==0b1110n){const i=BigInt(this.readUint8());const e=BigInt(this.readUint8());const s=BigInt(this.readUint8());return(t&0b00001111n)<<24n|i<<16n|e<<8n|s}else if(t>>3n==0b11110n){const i=BigInt(this.readUint8());const e=BigInt(this.readUint8());const s=BigInt(this.readUint8());const r=BigInt(this.readUint8());return(t&0b00000111n)<<32n|i<<24n|e<<16n|s<<8n|r}else if(t>>2n==0b111110n){const i=BigInt(this.readUint8());const e=BigInt(this.readUint8());const s=BigInt(this.readUint8());const r=BigInt(this.readUint8());const n=BigInt(this.readUint8());return(t&0b00000011n)<<40n|i<<32n|e<<24n|s<<16n|r<<8n|n}else if(t>>1n==0b1111110n){const i=BigInt(this.readUint8());const e=BigInt(this.readUint8());const s=BigInt(this.readUint8());const r=BigInt(this.readUint8());const n=BigInt(this.readUint8());const a=BigInt(this.readUint8());return(t&0b00000001n)<<48n|i<<40n|e<<32n|s<<24n|r<<16n|n<<8n|a}else if(t==0b11111110n){const t=BigInt(this.readUint8());const i=BigInt(this.readUint8());const e=BigInt(this.readUint8());const s=BigInt(this.readUint8());const r=BigInt(this.readUint8());const n=BigInt(this.readUint8());const a=BigInt(this.readUint8());return t<<48n|i<<40n|e<<32n|s<<24n|r<<16n|n<<8n|a}else{return this.readInt64()}}readArrayItf8(){var t=[];const i=this.readItf8();for(var e=0;e<i;e++){t.push(this.readItf8())}return t}readArrayByte(){const t=this.readItf8();return this.read(t)}readEncodingInt(){var t=new Map;t.set("codecId",this.readItf8());const i=this.readItf8();if(t.get("codecId")==1){t.set("externalId",this.readItf8());return t}else if(t.get("codecId")==3){t.set("alphabet",this.readArrayItf8());t.set("bit-length",this.readArrayItf8());return t}else if(t.get("codecId")==6){t.set("offset",this.readItf8());t.set("length",this.readItf8());return t}else if(t.get("codecId")==7){t.set("offset",this.readItf8());t.set("k",readItf8());return t}else if(t.get("codecId")==9){t.set("offset",readItf8());return t}else{console.log("Error: invalid codec ID");return t}}readEncodingByte(){var t=new Map;t.set("codecId",this.readItf8());const i=this.readItf8();if(t.get("codecId")==1){t.set("externalId",this.readItf8());return t}else if(t.get("codecId")==3){t.set("alphabet",this.readArrayItf8());t.set("bit-length",this.readArrayItf8());return t}else{console.log("Error: invalid codec ID");return t}}readEncodingByteArray(){var t=new Map;t.set("codecId",this.readItf8());const i=this.readItf8();if(t.get("codecId")==4){t.set("lengthsEncoding",this.readEncodingInt());t.set("valuesEncoding",this.readEncodingByte());return t}else if(t.get("codecId")==5){t.set("stopByte",this.read(1));t.set("externalId",this.readItf8());return t}else{console.log("Error: invalid codec ID");return t}}readBlock(t=-1){var i=new Map;if(t>=0){this.seek(t)}const e=this.tell();i.set("method",this.readInt8());i.set("contentTypeId",this.readInt8());i.set("contentId",this.readItf8());i.set("size",this.readItf8());i.set("rawSize",this.readItf8());const s=this.read(i.get("size"));var r;if(i.get("method")==0){r=s}else if(i.get("method")==1){var n=new Uint8Array(s);var a=new Zlib.Gunzip(n);var h=a.decompress();r=h.buffer}else if(i.get("method")==2){throw"bzip2 is not supported"}else if(i.get("method")==3){throw"lzma is not supported"}else if(i.get("method")==4){var o=new CramRans(s);r=o.ransDecode()}else{throw"unknown compression method"}i.set("IO",new CramStream(r));i.set("CRC32",this.readUint32());i.set("blockSize",this.tell()-e);return i}}var cram=undefined;onmessage=function(t){var i=t.data[0];var e=t.data[1];var s=t.data[2];switch(e){case"init":cram=new Cram(s[0],s[1],s[2],s[3],s[4]);postMessage([i]);break;case"read":cram.getRecords(s[0],s[1],s[2]).then((t=>{postMessage([i,t])})).catch((t=>{console.error(t)}));break}};
/** @license zlib.js 2012 - imaya [ https://github.com/imaya/zlib.js ] The MIT License */(function() {'use strict';function n(e){throw e;}var p=void 0,aa=this;function t(e,b){var d=e.split("."),c=aa;!(d[0]in c)&&c.execScript&&c.execScript("var "+d[0]);for(var a;d.length&&(a=d.shift());)!d.length&&b!==p?c[a]=b:c=c[a]?c[a]:c[a]={}};var x="undefined"!==typeof Uint8Array&&"undefined"!==typeof Uint16Array&&"undefined"!==typeof Uint32Array&&"undefined"!==typeof DataView;new (x?Uint8Array:Array)(256);var y;for(y=0;256>y;++y)for(var A=y,ba=7,A=A>>>1;A;A>>>=1)--ba;function B(e,b,d){var c,a="number"===typeof b?b:b=0,f="number"===typeof d?d:e.length;c=-1;for(a=f&7;a--;++b)c=c>>>8^C[(c^e[b])&255];for(a=f>>3;a--;b+=8)c=c>>>8^C[(c^e[b])&255],c=c>>>8^C[(c^e[b+1])&255],c=c>>>8^C[(c^e[b+2])&255],c=c>>>8^C[(c^e[b+3])&255],c=c>>>8^C[(c^e[b+4])&255],c=c>>>8^C[(c^e[b+5])&255],c=c>>>8^C[(c^e[b+6])&255],c=c>>>8^C[(c^e[b+7])&255];return(c^4294967295)>>>0}
var D=[0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,853044451,1172266101,3705015759,
2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,4240017532,1658658271,366619977,
2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,225274430,2053790376,3826175755,
2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,2998733608,733239954,1555261956,
3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,2932959818,3654703836,1088359270,
936918E3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117],C=x?new Uint32Array(D):D;function E(){}E.prototype.getName=function(){return this.name};E.prototype.getData=function(){return this.data};E.prototype.G=function(){return this.H};function G(e){var b=e.length,d=0,c=Number.POSITIVE_INFINITY,a,f,k,l,m,r,q,g,h,v;for(g=0;g<b;++g)e[g]>d&&(d=e[g]),e[g]<c&&(c=e[g]);a=1<<d;f=new (x?Uint32Array:Array)(a);k=1;l=0;for(m=2;k<=d;){for(g=0;g<b;++g)if(e[g]===k){r=0;q=l;for(h=0;h<k;++h)r=r<<1|q&1,q>>=1;v=k<<16|g;for(h=r;h<a;h+=m)f[h]=v;++l}++k;l<<=1;m<<=1}return[f,d,c]};var J=[],K;for(K=0;288>K;K++)switch(!0){case 143>=K:J.push([K+48,8]);break;case 255>=K:J.push([K-144+400,9]);break;case 279>=K:J.push([K-256+0,7]);break;case 287>=K:J.push([K-280+192,8]);break;default:n("invalid literal: "+K)}
var ca=function(){function e(a){switch(!0){case 3===a:return[257,a-3,0];case 4===a:return[258,a-4,0];case 5===a:return[259,a-5,0];case 6===a:return[260,a-6,0];case 7===a:return[261,a-7,0];case 8===a:return[262,a-8,0];case 9===a:return[263,a-9,0];case 10===a:return[264,a-10,0];case 12>=a:return[265,a-11,1];case 14>=a:return[266,a-13,1];case 16>=a:return[267,a-15,1];case 18>=a:return[268,a-17,1];case 22>=a:return[269,a-19,2];case 26>=a:return[270,a-23,2];case 30>=a:return[271,a-27,2];case 34>=a:return[272,
a-31,2];case 42>=a:return[273,a-35,3];case 50>=a:return[274,a-43,3];case 58>=a:return[275,a-51,3];case 66>=a:return[276,a-59,3];case 82>=a:return[277,a-67,4];case 98>=a:return[278,a-83,4];case 114>=a:return[279,a-99,4];case 130>=a:return[280,a-115,4];case 162>=a:return[281,a-131,5];case 194>=a:return[282,a-163,5];case 226>=a:return[283,a-195,5];case 257>=a:return[284,a-227,5];case 258===a:return[285,a-258,0];default:n("invalid length: "+a)}}var b=[],d,c;for(d=3;258>=d;d++)c=e(d),b[d]=c[2]<<24|c[1]<<
16|c[0];return b}();x&&new Uint32Array(ca);function L(e,b){this.i=[];this.j=32768;this.d=this.f=this.c=this.n=0;this.input=x?new Uint8Array(e):e;this.o=!1;this.k=M;this.w=!1;if(b||!(b={}))b.index&&(this.c=b.index),b.bufferSize&&(this.j=b.bufferSize),b.bufferType&&(this.k=b.bufferType),b.resize&&(this.w=b.resize);switch(this.k){case N:this.a=32768;this.b=new (x?Uint8Array:Array)(32768+this.j+258);break;case M:this.a=0;this.b=new (x?Uint8Array:Array)(this.j);this.e=this.D;this.q=this.A;this.l=this.C;break;default:n(Error("invalid inflate mode"))}}
var N=0,M=1;
L.prototype.g=function(){for(;!this.o;){var e=P(this,3);e&1&&(this.o=!0);e>>>=1;switch(e){case 0:var b=this.input,d=this.c,c=this.b,a=this.a,f=b.length,k=p,l=p,m=c.length,r=p;this.d=this.f=0;d+1>=f&&n(Error("invalid uncompressed block header: LEN"));k=b[d++]|b[d++]<<8;d+1>=f&&n(Error("invalid uncompressed block header: NLEN"));l=b[d++]|b[d++]<<8;k===~l&&n(Error("invalid uncompressed block header: length verify"));d+k>b.length&&n(Error("input buffer is broken"));switch(this.k){case N:for(;a+k>c.length;){r=
m-a;k-=r;if(x)c.set(b.subarray(d,d+r),a),a+=r,d+=r;else for(;r--;)c[a++]=b[d++];this.a=a;c=this.e();a=this.a}break;case M:for(;a+k>c.length;)c=this.e({t:2});break;default:n(Error("invalid inflate mode"))}if(x)c.set(b.subarray(d,d+k),a),a+=k,d+=k;else for(;k--;)c[a++]=b[d++];this.c=d;this.a=a;this.b=c;break;case 1:this.l(da,ea);break;case 2:for(var q=P(this,5)+257,g=P(this,5)+1,h=P(this,4)+4,v=new (x?Uint8Array:Array)(Q.length),s=p,F=p,H=p,w=p,z=p,O=p,I=p,u=p,Z=p,u=0;u<h;++u)v[Q[u]]=P(this,3);if(!x){u=
h;for(h=v.length;u<h;++u)v[Q[u]]=0}s=G(v);w=new (x?Uint8Array:Array)(q+g);u=0;for(Z=q+g;u<Z;)switch(z=R(this,s),z){case 16:for(I=3+P(this,2);I--;)w[u++]=O;break;case 17:for(I=3+P(this,3);I--;)w[u++]=0;O=0;break;case 18:for(I=11+P(this,7);I--;)w[u++]=0;O=0;break;default:O=w[u++]=z}F=x?G(w.subarray(0,q)):G(w.slice(0,q));H=x?G(w.subarray(q)):G(w.slice(q));this.l(F,H);break;default:n(Error("unknown BTYPE: "+e))}}return this.q()};
var S=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],Q=x?new Uint16Array(S):S,fa=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,258,258],ga=x?new Uint16Array(fa):fa,ha=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0],T=x?new Uint8Array(ha):ha,ia=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],ja=x?new Uint16Array(ia):ia,ka=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,
11,12,12,13,13],U=x?new Uint8Array(ka):ka,V=new (x?Uint8Array:Array)(288),W,la;W=0;for(la=V.length;W<la;++W)V[W]=143>=W?8:255>=W?9:279>=W?7:8;var da=G(V),X=new (x?Uint8Array:Array)(30),Y,ma;Y=0;for(ma=X.length;Y<ma;++Y)X[Y]=5;var ea=G(X);function P(e,b){for(var d=e.f,c=e.d,a=e.input,f=e.c,k=a.length,l;c<b;)f>=k&&n(Error("input buffer is broken")),d|=a[f++]<<c,c+=8;l=d&(1<<b)-1;e.f=d>>>b;e.d=c-b;e.c=f;return l}
function R(e,b){for(var d=e.f,c=e.d,a=e.input,f=e.c,k=a.length,l=b[0],m=b[1],r,q;c<m&&!(f>=k);)d|=a[f++]<<c,c+=8;r=l[d&(1<<m)-1];q=r>>>16;q>c&&n(Error("invalid code length: "+q));e.f=d>>q;e.d=c-q;e.c=f;return r&65535}
L.prototype.l=function(e,b){var d=this.b,c=this.a;this.r=e;for(var a=d.length-258,f,k,l,m;256!==(f=R(this,e));)if(256>f)c>=a&&(this.a=c,d=this.e(),c=this.a),d[c++]=f;else{k=f-257;m=ga[k];0<T[k]&&(m+=P(this,T[k]));f=R(this,b);l=ja[f];0<U[f]&&(l+=P(this,U[f]));c>=a&&(this.a=c,d=this.e(),c=this.a);for(;m--;)d[c]=d[c++-l]}for(;8<=this.d;)this.d-=8,this.c--;this.a=c};
L.prototype.C=function(e,b){var d=this.b,c=this.a;this.r=e;for(var a=d.length,f,k,l,m;256!==(f=R(this,e));)if(256>f)c>=a&&(d=this.e(),a=d.length),d[c++]=f;else{k=f-257;m=ga[k];0<T[k]&&(m+=P(this,T[k]));f=R(this,b);l=ja[f];0<U[f]&&(l+=P(this,U[f]));c+m>a&&(d=this.e(),a=d.length);for(;m--;)d[c]=d[c++-l]}for(;8<=this.d;)this.d-=8,this.c--;this.a=c};
L.prototype.e=function(){var e=new (x?Uint8Array:Array)(this.a-32768),b=this.a-32768,d,c,a=this.b;if(x)e.set(a.subarray(32768,e.length));else{d=0;for(c=e.length;d<c;++d)e[d]=a[d+32768]}this.i.push(e);this.n+=e.length;if(x)a.set(a.subarray(b,b+32768));else for(d=0;32768>d;++d)a[d]=a[b+d];this.a=32768;return a};
L.prototype.D=function(e){var b,d=this.input.length/this.c+1|0,c,a,f,k=this.input,l=this.b;e&&("number"===typeof e.t&&(d=e.t),"number"===typeof e.z&&(d+=e.z));2>d?(c=(k.length-this.c)/this.r[2],f=258*(c/2)|0,a=f<l.length?l.length+f:l.length<<1):a=l.length*d;x?(b=new Uint8Array(a),b.set(l)):b=l;return this.b=b};
L.prototype.q=function(){var e=0,b=this.b,d=this.i,c,a=new (x?Uint8Array:Array)(this.n+(this.a-32768)),f,k,l,m;if(0===d.length)return x?this.b.subarray(32768,this.a):this.b.slice(32768,this.a);f=0;for(k=d.length;f<k;++f){c=d[f];l=0;for(m=c.length;l<m;++l)a[e++]=c[l]}f=32768;for(k=this.a;f<k;++f)a[e++]=b[f];this.i=[];return this.buffer=a};
L.prototype.A=function(){var e,b=this.a;x?this.w?(e=new Uint8Array(b),e.set(this.b.subarray(0,b))):e=this.b.subarray(0,b):(this.b.length>b&&(this.b.length=b),e=this.b);return this.buffer=e};function $(e){this.input=e;this.c=0;this.m=[];this.s=!1}$.prototype.F=function(){this.s||this.g();return this.m.slice()};
$.prototype.g=function(){for(var e=this.input.length;this.c<e;){var b=new E,d=p,c=p,a=p,f=p,k=p,l=p,m=p,r=p,q=p,g=this.input,h=this.c;b.u=g[h++];b.v=g[h++];(31!==b.u||139!==b.v)&&n(Error("invalid file signature:"+b.u+","+b.v));b.p=g[h++];switch(b.p){case 8:break;default:n(Error("unknown compression method: "+b.p))}b.h=g[h++];r=g[h++]|g[h++]<<8|g[h++]<<16|g[h++]<<24;b.H=new Date(1E3*r);b.N=g[h++];b.M=g[h++];0<(b.h&4)&&(b.I=g[h++]|g[h++]<<8,h+=b.I);if(0<(b.h&8)){m=[];for(l=0;0<(k=g[h++]);)m[l++]=String.fromCharCode(k);
b.name=m.join("")}if(0<(b.h&16)){m=[];for(l=0;0<(k=g[h++]);)m[l++]=String.fromCharCode(k);b.J=m.join("")}0<(b.h&2)&&(b.B=B(g,0,h)&65535,b.B!==(g[h++]|g[h++]<<8)&&n(Error("invalid header crc16")));d=g[g.length-4]|g[g.length-3]<<8|g[g.length-2]<<16|g[g.length-1]<<24;g.length-h-4-4<512*d&&(f=d);c=new L(g,{index:h,bufferSize:f});b.data=a=c.g();h=c.c;b.K=q=(g[h++]|g[h++]<<8|g[h++]<<16|g[h++]<<24)>>>0;B(a,p,p)!==q&&n(Error("invalid CRC-32 checksum: 0x"+B(a,p,p).toString(16)+" / 0x"+q.toString(16)));b.L=
d=(g[h++]|g[h++]<<8|g[h++]<<16|g[h++]<<24)>>>0;(a.length&4294967295)!==d&&n(Error("invalid input size: "+(a.length&4294967295)+" / "+d));this.m.push(b);this.c=h}this.s=!0;var v=this.m,s,F,H=0,w=0,z;s=0;for(F=v.length;s<F;++s)w+=v[s].data.length;if(x){z=new Uint8Array(w);for(s=0;s<F;++s)z.set(v[s].data,H),H+=v[s].data.length}else{z=[];for(s=0;s<F;++s)z[s]=v[s].data;z=Array.prototype.concat.apply([],z)}return z};t("Zlib.Gunzip",$);t("Zlib.Gunzip.prototype.decompress",$.prototype.g);t("Zlib.Gunzip.prototype.getMembers",$.prototype.F);t("Zlib.GunzipMember",E);t("Zlib.GunzipMember.prototype.getName",E.prototype.getName);t("Zlib.GunzipMember.prototype.getData",E.prototype.getData);t("Zlib.GunzipMember.prototype.getMtime",E.prototype.G);}).call(this);
